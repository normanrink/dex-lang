<!DOCTYPE HTML>
<html><head><meta charset="UTF-8"><style type="text/css">/* Copyright 2019 Google LLC                              */
/*                                                        */
/* Use of this source code is governed by a BSD-style     */
/* license that can be found in the LICENSE file or at    */
/* https://developers.google.com/open-source/licenses/bsd */

body {
  font-family: Helvetica, sans-serif;
  font-size: 100%;
  color: #333;
  display: flex;
  justify-content: space-between;
  overflow-x: hidden;

  --main-width: 50rem;
  --nav-width: 20rem;
}

@media (max-width: 70rem) {
    /*For narrow screens hide nav and enable horizontal scrolling */
    nav {display: none;}
    body {overflow-x: auto;}
}

nav {/* this actually just holds space for #navbar, which is fixed */
  min-width: var(--nav-width);
  max-width: var(--nav-width);
}
#navbar {
  position: fixed;
  height: 100vh;
  width: var(--nav-width);
  overflow-y: scroll;
  border-right: 1px solid firebrick;
}
#navbar:before {
  content: "Contents";
  font-weight: bold;
}
nav ol {
  list-style-type:none;
  padding-left: 1rem;
}

#main-output {
  max-width: var(--main-width);
  margin: auto;
}

.cell {
}

.code-block, .err-block, .result-block {
  padding: 0em 0em 0em 2em;
  display: block;
  font-family: monospace;
  white-space: pre;
}

code {
  background-color: #F0F0F0;
}

.result-block {
  border-left: 3px solid  #87CEFA;
}

.prose-block {
  line-height: 140%;
}

.err-block {
  font-weight: bold;
  color: #B22222;
  border-left: 3px solid #B22222;
}

.plot {
  padding: 5em;
}

.plot-img {
  width: 80%;
}

.comment {
  color: #808080;
}

.keyword {
  color: #0000DD;
}

.command {
  color: #A80000;
}

.symbol {
  color: #E07000;
}

.type-name {
  color: #A80000;
}

.iso-sugar {
  color: #25BBA7;
}
</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" onload="// Copyright 2019 Google LLC
//
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file or at
// https://developers.google.com/open-source/licenses/bsd

var katexOptions = {
    delimiters: [
        {left: &quot;$$&quot;, right: &quot;$$&quot;, display: true},
        {left: &quot;\\[&quot;, right: &quot;\\]&quot;, display: true},
        {left: &quot;$&quot;, right: &quot;$&quot;, display: false},
        {left: &quot;\\(&quot;, right: &quot;\\)&quot;, display: false}
    ],
    // Enable commands that load resources or change HTML attributes
    // (e.g. hyperlinks): https://katex.org/docs/security.html.
    trust: true
};

var cells = {};

function append_contents(key, contents) {
    if (key in cells) {
        var cur_cells = cells[key];
    } else {
        var cell = document.createElement(&quot;div&quot;);
        cell.className = &quot;cell&quot;;
        cells[key] = [cell];
        var cur_cells = [cell];
    }
    for (var i = 0; i &lt; contents.length; i++) {
        for (var j = 0; j &lt; cur_cells.length; j++) {
            var node = lookup_address(cur_cells[j], contents[i][0])
            node.innerHTML += contents[i][1];
        }
    }
}

function lookup_address(cell, address) {
    var node = cell
    for (i = 0; i &lt; address.length; i++) {
        node = node.children[address[i]]
    }
    return node
}

function renderLaTeX() {
    // Render LaTeX equations in prose blocks via KaTeX, if available.
    // Skip rendering if KaTeX is unavailable.
    if (typeof renderMathInElement == &#39;undefined&#39;) {
        return;
    }
    // Render LaTeX equations in prose blocks via KaTeX.
    var proseBlocks = document.querySelectorAll(&quot;.prose-block&quot;);
    Array.from(proseBlocks).map((proseBlock) =&gt;
        renderMathInElement(proseBlock, katexOptions)
    );
}

/**
 * Rendering the Table of Contents / Navigation Bar
 * 2 key functions
 *  - `updateNavigation()` which inserts/updates the navigation bar
 *  - and it&#39;s helper `extractStructure()` which extracts the structure of the page
 *    and adds ids to heading elements.
*/
function updateNavigation() {
    function navItemList(struct) {
        var listEle = document.createElement(&#39;ol&#39;)
        struct.children.forEach(childStruct=&gt;
            listEle.appendChild(navItem(childStruct))
        );
        return listEle;
    }
    function navItem(struct) {
        var a = document.createElement(&#39;a&#39;);
        a.appendChild(document.createTextNode(struct.text));
        a.title = struct.text;
        a.href = &quot;#&quot;+struct.id;

        var ele = document.createElement(&#39;li&#39;)
        ele.appendChild(a)
        ele.appendChild(navItemList(struct));
        return ele;
    }

    var navbarEle = document.getElementById(&quot;navbar&quot;)
    if (navbarEle === null) {  // create it
        navbarEle = document.createElement(&quot;div&quot;);
        navbarEle.id=&quot;navbar&quot;;
        navOuterEle = document.createElement(&quot;nav&quot;)
        navOuterEle.appendChild(navbarEle);
        document.body.prepend(navOuterEle);
    }

    navbarEle.innerHTML = &quot;&quot;
    var structure = extractStructure()
    navbarEle.appendChild(navItemList(structure));
}

function extractStructure() { // Also sets ids on h1,h2,...
    var headingsNodes = document.querySelectorAll(&quot;h1, h2, h3, h4, h5, h6&quot;);
    // For now we are just fulling going to regenerate the structure each time
    // Might be better if we made minimal changes, but ðŸ¤·

    // Extract the structure of the document
    var structure = {children:[]}
    var active = [structure.children];
    headingsNodes.forEach(
        function(currentValue, currentIndex) {
            currentValue.id = &quot;s-&quot; + currentIndex;
            var currentLevel = parseInt(currentValue.nodeName[1]);

            // Insert dummy levels up for any levels that are skipped
            for (var i=active.length; i &lt; currentLevel; i++) {
                var dummy = {id: &quot;&quot;, text: &quot;&quot;, children: []}
                active.push(dummy.children);
                var parentList = active[i-1]
                parentList.push(dummy);
            }
            // delete this level and everything after
            active.splice(currentLevel, active.length);

            var currentStructure = {
                id: currentValue.id,
                text: currentValue.textContent,
                children: [],
            };
            active.push(currentStructure.children);

            var parentList = active[active.length-2]
            parentList.push(currentStructure);
        },
    );
    return structure;
}

/**
 * HTML rendering mode.
 * Static rendering is used for static HTML pages.
 * Dynamic rendering is used for dynamic HTML pages via `dex web`.
 *
 * @enum {string}
 */
var RENDER_MODE = Object.freeze({
  STATIC: &quot;static&quot;,
  DYNAMIC: &quot;dynamic&quot;,
})

/**
 * Renders the webpage.
 * @param {RENDER_MODE} renderMode The render mode, either static or dynamic.
 */
function render(renderMode) {
    if (renderMode == RENDER_MODE.STATIC) {
        // For static pages, simply call rendering functions once.
        renderLaTeX();
        updateNavigation();
    } else {
        // For dynamic pages (via `dex web`), listen to update events.
        var source = new EventSource(&quot;/getnext&quot;);
        source.onmessage = function(event) {
            var body = document.getElementById(&quot;main-output&quot;);
            var msg = JSON.parse(event.data);
            if (msg == &quot;start&quot;) {
                body.innerHTML = &quot;&quot;;
                cells = {}
                return
            }
            var order    = msg[0];
            var contents = msg[1];
            for (var i = 0; i &lt; contents.length; i++) {
                append_contents(contents[i][0], contents[i][1]);
            }
            if (order != null) {
                var new_cells = {};
                body.innerHTML = &quot;&quot;;
                for (var i = 0; i &lt; order.val.length; i++) {
                    var key = order.val[i]
                    var cur_cells = cells[key]
                    if (cur_cells.length == 0) {
                        var cur_cell = new_cells[key][0].cloneNode(true)
                    } else {
                        var cur_cell = cur_cells.pop()
                        if (key in new_cells) {
                            new_cells[key].push(cur_cell);
                        } else {
                            new_cells[key] = [cur_cell];
                        }
                    }
                    body.appendChild(cur_cell);
                }
                Object.assign(cells, new_cells);
            }
            renderLaTeX();
            updateNavigation();
        };
    }
}
render(RENDER_MODE.STATIC);"></script></head><body><div id="main-output"><div class="cell"><div class="code-block"></div></div><div class="cell"><div class="prose-block"><h1>Dex prelude</h1>
</div></div><div class="cell"><div class="prose-block"><p>Runs before every Dex program unless an alternative is provided with <code>--prelude</code>.</p>
</div></div><div class="cell"><div class="prose-block"><h2>Essentials</h2>
<h3>Primitive Types</h3>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">TyKind</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Heap</span> <span class="symbol">=</span> %<span class="type-name">HeapType</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Effects</span> <span class="symbol">=</span> %<span class="type-name">EffKind</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Fields</span> <span class="symbol">=</span> %<span class="type-name">LabeledRowKind</span>()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int64</span> <span class="symbol">=</span> %<span class="type-name">Int64</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int32</span> <span class="symbol">=</span> %<span class="type-name">Int32</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float64</span> <span class="symbol">=</span> %<span class="type-name">Float64</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float32</span> <span class="symbol">=</span> %<span class="type-name">Float32</span>()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word8</span>  <span class="symbol">=</span> %<span class="type-name">Word8</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word32</span> <span class="symbol">=</span> %<span class="type-name">Word32</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word64</span> <span class="symbol">=</span> %<span class="type-name">Word64</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">Byte</span> <span class="symbol">=</span> <span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Char</span> <span class="symbol">=</span> <span class="type-name">Byte</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Label</span> <span class="symbol">=</span> %<span class="type-name">Label</span>()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">RawPtr</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Word8Ptr</span>()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int</span> <span class="symbol">=</span> <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> the(a<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Data</span>(a<span class="symbol">:</span><span class="type-name">Type</span>)
  <span class="keyword">do</span>_not_implement_this_<span class="keyword">interface</span>_<span class="keyword">for</span>_the_compiler_relies_on_the_invariant_it_protects <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Casting</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> internal_cast(x<span class="command">:from</span>) <span class="symbol">-&gt;</span> to <span class="keyword">given</span> (from<span class="symbol">,</span> to) <span class="symbol">=</span>
  %cast(to<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_coerce(x<span class="command">:from</span>) <span class="symbol">-&gt;</span> to <span class="keyword">given</span> (from<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> to<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span> %unsafeCoerce(to<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> uninitialized_value() <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span> %garbageVal(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f64_to_f(x<span class="symbol">:</span> <span class="type-name">Float64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f32_to_f(x<span class="symbol">:</span> <span class="type-name">Float32</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_f64(x<span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Float64</span> <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_f32(x<span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Float32</span> <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i64_to_i(x<span class="symbol">:</span> <span class="type-name">Int64</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i32_to_i(x<span class="symbol">:</span> <span class="type-name">Int32</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w8_to_i(x<span class="symbol">:</span> <span class="type-name">Word8</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_i64(x<span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">-&gt;</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_i32(x<span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">-&gt;</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_w8(x<span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">-&gt;</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_w32(x<span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">-&gt;</span> <span class="type-name">Word32</span>  <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_w64(x<span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">-&gt;</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w32_to_w64(x<span class="symbol">:</span> <span class="type-name">Word32</span>)<span class="symbol">-&gt;</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_f(x<span class="symbol">:</span><span class="type-name">Int</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_i(x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int</span>   <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> raw_ptr_to_i64(x<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int64</span>  <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Nat</span> <span class="symbol">=</span> %<span class="type-name">Nat</span>()
</div></div><div class="cell"><div class="code-block"><span class="type-name">NatRep</span> <span class="symbol">=</span> <span class="type-name">Word32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> nat_to_rep(x <span class="symbol">:</span> <span class="type-name">Nat</span>)    <span class="symbol">-&gt;</span> <span class="type-name">NatRep</span> <span class="symbol">=</span> %projNewtype(x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rep_to_nat(x <span class="symbol">:</span> <span class="type-name">NatRep</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span>    <span class="symbol">=</span> %<span class="type-name">NatCon</span>(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_w8(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_w32(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word32</span>  <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_w64(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_i32(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_i64(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_f32(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float32</span> <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_f64(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float64</span> <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_f(x<span class="symbol">:</span> <span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span>   <span class="symbol">=</span> nat_to_rep x <span class="symbol">|</span> internal_cast
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w8_to_n(x <span class="symbol">:</span> <span class="type-name">Word8</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w32_to_n(x <span class="symbol">:</span> <span class="type-name">Word32</span>)  <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w64_to_n(x <span class="symbol">:</span> <span class="type-name">Word64</span>)  <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i32_to_n(x <span class="symbol">:</span> <span class="type-name">Int32</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i64_to_n(x <span class="symbol">:</span> <span class="type-name">Int64</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f32_to_n(x <span class="symbol">:</span> <span class="type-name">Float32</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f64_to_n(x <span class="symbol">:</span> <span class="type-name">Float64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> f_to_n(x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> internal_cast x <span class="symbol">|</span> rep_to_nat
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">FromUnsignedInteger</span>(a<span class="symbol">:</span><span class="type-name">Type</span>)
  from_unsigned_integer <span class="symbol">:</span> (<span class="type-name">Word64</span>) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromUnsignedInteger</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> from_unsigned_integer(x) <span class="symbol">=</span> w64_to_n(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">FromInteger</span>(a<span class="symbol">:</span><span class="type-name">Type</span>)
  from_integer <span class="symbol">:</span> (<span class="type-name">Int64</span>) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> from_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> from_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> from_integer(x) <span class="symbol">=</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">FromInteger</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> from_integer(x) <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Bitwise operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Bits</span>(a<span class="symbol">:</span><span class="type-name">Type</span>)
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">:</span> (a<span class="symbol">,</span> <span class="type-name">Int</span>) <span class="symbol">-&gt;</span> a
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">:</span> (a<span class="symbol">,</span> <span class="type-name">Int</span>) <span class="symbol">-&gt;</span> a
  (<span class="symbol">.|.</span>)   <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
  (<span class="symbol">.^.</span>)   <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> (<span class="symbol">.&lt;&lt;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %shl(x<span class="symbol">,</span> i_to_w8 y)
  <span class="keyword">def</span> (<span class="symbol">.&gt;&gt;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %shr(x<span class="symbol">,</span> i_to_w8 y)
  <span class="keyword">def</span> (<span class="symbol">.|.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %or( x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">.&amp;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %and(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">.^.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %xor(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> (<span class="symbol">.&lt;&lt;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %shl(x<span class="symbol">,</span> i_to_w32 y)
  <span class="keyword">def</span> (<span class="symbol">.&gt;&gt;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %shr(x<span class="symbol">,</span> i_to_w32 y)
  <span class="keyword">def</span> (<span class="symbol">.|.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %or( x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">.&amp;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %and(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">.^.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %xor(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> (<span class="symbol">.&lt;&lt;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %shl(x<span class="symbol">,</span> i_to_w64 y)
  <span class="keyword">def</span> (<span class="symbol">.&gt;&gt;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %shr(x<span class="symbol">,</span> i_to_w64 y)
  <span class="keyword">def</span> (<span class="symbol">.|.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %or( x <span class="symbol">,</span>y)
  <span class="keyword">def</span> (<span class="symbol">.&amp;.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %and(x <span class="symbol">,</span>y)
  <span class="keyword">def</span> (<span class="symbol">.^.</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %xor(x <span class="symbol">,</span>y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> low_word( x <span class="symbol">:</span> <span class="type-name">Word64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word32</span> <span class="symbol">=</span> internal_cast(x <span class="symbol">.&gt;&gt;.</span> 32)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> high_word(x <span class="symbol">:</span> <span class="type-name">Word64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word32</span> <span class="symbol">=</span> internal_cast(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Basic Arithmetic</h3>
<h4>Add</h4>
<p>Things that can be added.
This defines the <code>Add</code> <a href="https://en.wikipedia.org/wiki/Group_(mathematics)">group</a> and its operators.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Add</span>(a<span class="symbol">|</span><span class="type-name">Data</span>)
  (<span class="symbol">+</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
  zero <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Sub</span>(a<span class="symbol">|</span><span class="type-name">Add</span>)
  (<span class="symbol">-</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fsub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fsub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %iadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %isub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %iadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %isub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %iadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %isub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %iadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %isub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %iadd(x<span class="symbol">,</span> y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %isub(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> rep_to_nat %iadd(nat_to_rep x<span class="symbol">,</span> nat_to_rep y)
  zero <span class="symbol">=</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(())
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> ()
  zero <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(())
  <span class="keyword">def</span> (<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Mul</h4>
<p>Things that can be multiplied.
This defines the <code>Mul</code> <a href="https://en.wikipedia.org/wiki/Monoid">Monoid</a>, and its operator.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Mul</span>(a<span class="symbol">|</span><span class="type-name">Data</span>)
  (<span class="symbol">*</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
  one <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fmul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> f_to_f64 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fmul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> f_to_f32 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %imul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %imul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %imul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %imul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> %imul(x<span class="symbol">,</span> y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span>(<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> rep_to_nat %imul(nat_to_rep x<span class="symbol">,</span> nat_to_rep y)
  one <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(())
  <span class="keyword">def</span> (<span class="symbol">*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> ()
  one <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Integral</h4>
<p>Integer-like things.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Integral</span>(a)
  idiv <span class="symbol">:</span> (a<span class="symbol">,</span>a)<span class="symbol">-&gt;</span>a
  rem  <span class="symbol">:</span> (a<span class="symbol">,</span>a)<span class="symbol">-&gt;</span>a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> idiv(x<span class="symbol">,</span> y) <span class="symbol">=</span> %idiv(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> rem(x<span class="symbol">,</span> y) <span class="symbol">=</span> %irem(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> idiv(x<span class="symbol">,</span> y) <span class="symbol">=</span> %idiv(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> rem(x<span class="symbol">,</span> y) <span class="symbol">=</span> %irem(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> idiv(x<span class="symbol">,</span> y) <span class="symbol">=</span> %idiv(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> rem(x<span class="symbol">,</span> y) <span class="symbol">=</span> %irem(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> idiv(x<span class="symbol">,</span> y) <span class="symbol">=</span> %idiv(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> rem(x<span class="symbol">,</span> y) <span class="symbol">=</span> %irem(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> idiv(x<span class="symbol">,</span> y) <span class="symbol">=</span> %idiv(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> rem(x<span class="symbol">,</span> y) <span class="symbol">=</span> %irem(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> idiv(x<span class="symbol">,</span> y) <span class="symbol">=</span> rep_to_nat %idiv(nat_to_rep x<span class="symbol">,</span> (nat_to_rep y))
  <span class="keyword">def</span> rem(x<span class="symbol">,</span> y) <span class="symbol">=</span> rep_to_nat %irem(nat_to_rep x<span class="symbol">,</span> (nat_to_rep y))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Fractional</h4>
<p>Rational-like things.
Includes floating point and two field rational representations.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Fractional</span>(a)
  divide <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> divide(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fdiv(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> divide(x<span class="symbol">,</span> y) <span class="symbol">=</span> %fdiv(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Index set interface and instances</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Ix</span>(n<span class="symbol">|</span><span class="type-name">Data</span>)
  size&#39; <span class="symbol">:</span> () <span class="symbol">-&gt;</span> <span class="type-name">Nat</span>
  ordinal <span class="symbol">:</span> (n) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span>
  unsafe_from_ordinal <span class="symbol">:</span> (<span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> size(n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> size&#39;(n<span class="symbol">=</span>n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Fin</span>(n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Fin</span>(n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- version of subtraction on Nats that clamps at zero
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">-|</span>)(x<span class="symbol">:</span> <span class="type-name">Nat</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> nat_to_rep x
  y&#39; <span class="symbol">=</span> nat_to_rep y
  requires_clamp <span class="symbol">=</span> %ilt(x&#39;<span class="symbol">,</span> y&#39;)
  rep_to_nat %select(requires_clamp<span class="symbol">,</span> 0<span class="symbol">,</span> (%isub(x&#39;<span class="symbol">,</span> y&#39;)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_nat_diff(x<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> nat_to_rep x
  y&#39; <span class="symbol">=</span> nat_to_rep y
  rep_to_nat %isub(x&#39;<span class="symbol">,</span> y&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(i..)` parses as `RangeFrom _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: need to a way to indicate `.new` as private
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">RangeFrom</span>(q<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> i<span class="command">:q</span>) <span class="symbol">=</span> val <span class="symbol">:</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(i&lt;..)` parses as `RangeFromExc _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">RangeFromExc</span>(q<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> i<span class="command">:q</span>) <span class="symbol">=</span> val <span class="symbol">:</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(..i)` parses as `RangeTo _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">RangeTo</span>(q<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> i<span class="command">:q</span>) <span class="symbol">=</span> val <span class="symbol">:</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `(..&lt;i)` parses as `RangeToExc _ i`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">RangeToExc</span>(q<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> i<span class="command">:q</span>) <span class="symbol">=</span> val <span class="symbol">:</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">RangeFrom</span> q i) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> unsafe_nat_diff(size q<span class="symbol">,</span> ordinal i)
  <span class="keyword">def</span> ordinal(j) <span class="symbol">=</span> j<span class="symbol">.</span>val
  <span class="keyword">def</span> unsafe_from_ordinal(j) <span class="symbol">=</span> <span class="type-name">RangeFrom</span><span class="symbol">.</span>new(j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">RangeFromExc</span> q i) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> unsafe_nat_diff(size q<span class="symbol">,</span> ordinal i <span class="symbol">+</span> 1)
  <span class="keyword">def</span> ordinal(j) <span class="symbol">=</span> j<span class="symbol">.</span>val
  <span class="keyword">def</span> unsafe_from_ordinal(j) <span class="symbol">=</span> <span class="type-name">RangeFromExc</span><span class="symbol">.</span>new(j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">RangeTo</span> q i) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> ordinal i <span class="symbol">+</span> 1
  <span class="keyword">def</span> ordinal(j) <span class="symbol">=</span> j<span class="symbol">.</span>val
  <span class="keyword">def</span> unsafe_from_ordinal(j) <span class="symbol">=</span> <span class="type-name">RangeTo</span><span class="symbol">.</span>new(j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">RangeToExc</span> q i) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> ordinal i
  <span class="keyword">def</span> ordinal(j) <span class="symbol">=</span> j<span class="symbol">.</span>val
  <span class="keyword">def</span> unsafe_from_ordinal(j) <span class="symbol">=</span> <span class="type-name">RangeToExc</span><span class="symbol">.</span>new(j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(())
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> 1
  <span class="keyword">def</span> ordinal(_) <span class="symbol">=</span> 0
  <span class="keyword">def</span> unsafe_from_ordinal(_) <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iota(n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span><span class="type-name">Nat</span> <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Arithmetic instances for table types</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">+</span> ys[i]
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">-</span> ys[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="comment">-- Upper triangular tables
</span>  <span class="keyword">def</span> (<span class="symbol">+</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">+</span> ys[i]
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)  <span class="comment">-- Upper triangular tables
</span>  <span class="keyword">def</span> (<span class="symbol">-</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">-</span> ys[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)  <span class="comment">-- Lower triangular tables
</span>  <span class="keyword">def</span> (<span class="symbol">+</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">+</span> ys[i]
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)  <span class="comment">-- Lower triangular tables
</span>  <span class="keyword">def</span> (<span class="symbol">-</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">-</span> ys[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">+</span> ys[i]
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">-</span> ys[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">+</span> ys[i]
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">-</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">-</span> ys[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Mul</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">*</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs[i] <span class="symbol">*</span> ys[i]
  one <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> one
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Basic polymorphic functions and types</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst(pair<span class="symbol">:</span>(a<span class="symbol">,</span> b)) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span>
  (x<span class="symbol">,</span> _) <span class="symbol">=</span> pair
  x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd(pair<span class="symbol">:</span>(a<span class="symbol">,</span> b)) <span class="symbol">-&gt;</span> b <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span>
  (_<span class="symbol">,</span> y) <span class="symbol">=</span> pair
  y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap(pair<span class="symbol">:</span>(a<span class="symbol">,</span> b)) <span class="symbol">-&gt;</span> (b<span class="symbol">,</span> a) <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span>
  (x<span class="symbol">,</span> y) <span class="symbol">=</span> pair
  (y<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Add</span>)
  <span class="keyword">def</span> (<span class="symbol">+</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span>
    (x1<span class="symbol">,</span> x2) <span class="symbol">=</span> x
    (y1<span class="symbol">,</span> y2) <span class="symbol">=</span> y
    (x1 <span class="symbol">+</span> y1<span class="symbol">,</span> x2 <span class="symbol">+</span> y2)
  zero <span class="symbol">=</span> (zero<span class="symbol">,</span> zero)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Sub</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Sub</span>)
  <span class="keyword">def</span>(<span class="symbol">-</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span>
    (x1<span class="symbol">,</span> x2) <span class="symbol">=</span> x
    (y1<span class="symbol">,</span> y2) <span class="symbol">=</span> y
    (x1 <span class="symbol">-</span> y1<span class="symbol">,</span> x2 <span class="symbol">-</span> y2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> size a <span class="symbol">*</span> size b
  <span class="keyword">def</span> ordinal(pair) <span class="symbol">=</span>
    (i<span class="symbol">,</span> j) <span class="symbol">=</span> pair
    (ordinal i <span class="symbol">*</span> size b) <span class="symbol">+</span> ordinal j
  <span class="keyword">def</span> unsafe_from_ordinal(o) <span class="symbol">=</span>
    bs <span class="symbol">=</span> size b
    (unsafe_from_ordinal(n<span class="symbol">=</span>a<span class="symbol">,</span> idiv(o<span class="symbol">,</span> bs))<span class="symbol">,</span> unsafe_from_ordinal(n<span class="symbol">=</span>b<span class="symbol">,</span> rem(o<span class="symbol">,</span> bs)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>((a<span class="symbol">,</span> b<span class="symbol">,</span> c)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> c<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> size a <span class="symbol">*</span> size b <span class="symbol">*</span> size c
  <span class="keyword">def</span> ordinal(tup) <span class="symbol">=</span>
    (i<span class="symbol">,</span> j<span class="symbol">,</span> k) <span class="symbol">=</span> tup
    ordinal((i<span class="symbol">,</span>(j<span class="symbol">,</span>k)))
  <span class="keyword">def</span> unsafe_from_ordinal(o) <span class="symbol">=</span>
    (i<span class="symbol">,</span> (j<span class="symbol">,</span> k)) <span class="symbol">=</span> unsafe_from_ordinal o
    (i<span class="symbol">,</span> j<span class="symbol">,</span> k)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Vector spaces</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">VSpace</span>(a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">|</span><span class="type-name">Sub</span>)
  (<span class="symbol">.*</span>) <span class="symbol">:</span> (<span class="type-name">Float</span><span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*.</span>)(v<span class="command">:a</span><span class="symbol">,</span> s<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span> s <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/</span>)( v<span class="command">:a</span><span class="symbol">,</span> s<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span> divide(1<span class="symbol">.</span>0<span class="symbol">,</span> s) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> neg( v<span class="command">:a</span>)          <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span> (<span class="symbol">-</span>1<span class="symbol">.</span>0) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>(<span class="type-name">Float</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">*</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">VSpace</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(s<span class="symbol">,</span> xs) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">VSpace</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">VSpace</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(s<span class="symbol">,</span> pair) <span class="symbol">=</span>
    (a<span class="symbol">,</span> b) <span class="symbol">=</span> pair
    (s <span class="symbol">.*</span> a<span class="symbol">,</span> s <span class="symbol">.*</span> b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">VSpace</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(s<span class="symbol">,</span> xs) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">VSpace</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(s<span class="symbol">,</span> xs) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">VSpace</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(s<span class="symbol">,</span> xs) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>((i<span class="command">:n</span>) <span class="symbol">=&gt;</span> (i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">VSpace</span>)
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(s<span class="symbol">,</span> xs) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span>(())
  <span class="keyword">def</span> (<span class="symbol">.*</span>)(_<span class="symbol">,</span> _) <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Boolean type</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="type-name">False</span>
  <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_w8(x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> w8_to_b(x<span class="symbol">:</span><span class="type-name">Word8</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> %toEnum(<span class="type-name">Bool</span><span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&amp;</span>)(x<span class="symbol">:</span><span class="type-name">Bool</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> b_to_w8 x
  y&#39; <span class="symbol">=</span> b_to_w8 y
  w8_to_b <span class="symbol">$</span> %and(x&#39;<span class="symbol">,</span> y&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">||</span>)(x<span class="symbol">:</span><span class="type-name">Bool</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> b_to_w8 x
  y&#39; <span class="symbol">=</span> b_to_w8 y
  w8_to_b <span class="symbol">$</span> %or(x&#39;<span class="symbol">,</span> y&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> not(x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> b_to_w8 x
  w8_to_b <span class="symbol">$</span> %not(x&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>More Boolean operations</h2>
<p>TODO: move these with the others?</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Can&#39;t use `%select` because it lowers to `ISelect`, which requires
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- `a` to be a `BaseTy`.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> select(p<span class="symbol">:</span><span class="type-name">Bool</span><span class="symbol">,</span> x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="keyword">case</span> p <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> x
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_i(x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int</span>   <span class="symbol">=</span> w8_to_i(b_to_w8 x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_n(x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span>   <span class="symbol">=</span> w8_to_n(b_to_w8 x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b_to_f(x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span> i_to_f(b_to_i x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Ordering</h2>
<p>TODO: move this down to with <code>Ord</code>?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
  <span class="type-name">LT</span>
  <span class="type-name">EQ</span>
  <span class="type-name">GT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> o_to_w8(x<span class="symbol">:</span><span class="type-name">Ordering</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Sum types</h2>
<p>A <a href="https://en.wikipedia.org/wiki/Tagged_union">sum type, or tagged union</a> can hold values from a fixed set of types, distinguished by tags.
For those familiar with the C language, they can be though of as a combination of an <code>enum</code> with a <code>union</code>.
Here we define several basic kinds, and some operators on them.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Maybe</span>(a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">=</span>
  <span class="type-name">Nothing</span>
  <span class="type-name">Just</span>(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_nothing(x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">True</span>
    <span class="type-name">Just</span>(_) <span class="symbol">-&gt;</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_just(x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a) <span class="symbol">=</span> not <span class="symbol">$</span> is_nothing x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maybe(d<span class="command">:b</span><span class="symbol">,</span> f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>b<span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">-&gt;</span> b <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Nothing</span>  <span class="symbol">-&gt;</span> d
    <span class="type-name">Just</span>(x&#39;) <span class="symbol">-&gt;</span> f x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Either</span>(a<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> b<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">=</span>
  <span class="type-name">Left</span>(a)
  <span class="type-name">Right</span>(b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">Either</span>(a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> size a <span class="symbol">+</span> size b
  <span class="keyword">def</span> ordinal(i) <span class="symbol">=</span> <span class="keyword">case</span> i <span class="keyword">of</span>
    <span class="type-name">Left</span>(ai)  <span class="symbol">-&gt;</span> ordinal ai
    <span class="type-name">Right</span>(bi) <span class="symbol">-&gt;</span> ordinal bi <span class="symbol">+</span> size a
  <span class="keyword">def</span> unsafe_from_ordinal(o) <span class="symbol">=</span>
    as <span class="symbol">=</span> nat_to_rep <span class="symbol">$</span> size a
    o&#39; <span class="symbol">=</span> nat_to_rep o
    <span class="comment">-- TODO: Reshuffle the prelude to be able to use (&lt;) here
</span>    <span class="keyword">case</span> w8_to_b <span class="symbol">$</span> %ilt(o&#39;<span class="symbol">,</span> as) <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Left</span> <span class="symbol">$</span> unsafe_from_ordinal(n<span class="symbol">=</span>a<span class="symbol">,</span> o)
      <span class="comment">-- TODO: Reshuffle the prelude to be able to use `diff_nat` here
</span>      <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Right</span> <span class="symbol">$</span> unsafe_from_ordinal(n<span class="symbol">=</span>b<span class="symbol">,</span> rep_to_nat (%isub(o&#39;<span class="symbol">,</span> as)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Subtraction on Nats</h2>
<p>-- TODO: think more about the right API here</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_i_to_n(x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  rep_to_nat <span class="symbol">$</span> internal_cast x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> n_to_i(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int</span> <span class="symbol">=</span>
  internal_cast (nat_to_rep x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i_to_n(x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  <span class="keyword">if</span> w8_to_b <span class="symbol">$</span> %ilt(x<span class="symbol">,</span> 0<span class="symbol">::</span><span class="type-name">Int</span>)
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> unsafe_i_to_n x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Fencepost index sets</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">Post</span>(segment<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">=</span>
  val <span class="symbol">:</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">Post</span> segment) <span class="keyword">given</span> (segment<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> size segment <span class="symbol">+</span> 1
  <span class="keyword">def</span> ordinal(i) <span class="symbol">=</span> i<span class="symbol">.</span>val
  <span class="keyword">def</span> unsafe_from_ordinal(i) <span class="symbol">=</span> <span class="type-name">Post</span><span class="symbol">.</span>new(i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> left_post(i<span class="command">:n</span>) <span class="symbol">-&gt;</span> <span class="type-name">Post</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  unsafe_from_ordinal(n<span class="symbol">=</span><span class="type-name">Post</span> n<span class="symbol">,</span> ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> right_post(i<span class="command">:n</span>) <span class="symbol">-&gt;</span> <span class="type-name">Post</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  unsafe_from_ordinal(n<span class="symbol">=</span><span class="type-name">Post</span> n<span class="symbol">,</span> ordinal i <span class="symbol">+</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">NonEmpty</span>(n<span class="symbol">|</span><span class="type-name">Ix</span>)
  first_ix <span class="symbol">:</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> last_ix() <span class="symbol">-&gt;&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">NonEmpty</span>) <span class="symbol">=</span>
  unsafe_from_ordinal(unsafe_i_to_n(n_to_i(size n) <span class="symbol">-</span> 1))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>(<span class="type-name">Post</span> n) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>)
  first_ix <span class="symbol">=</span> unsafe_from_ordinal(n<span class="symbol">=</span><span class="type-name">Post</span> n<span class="symbol">,</span> 0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>(())
  first_ix <span class="symbol">=</span> unsafe_from_ordinal(0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Monoid</h3>
<p>A <a href="https://en.wikipedia.org/wiki/Monoid">monoid</a> is a things that have an associative binary operator and an identity element.
This is a very useful and general calls of things.
It includes:</p>
<ul>
<li>Addition and Multiplication of Numbers</li>
<li>Boolean Logic</li>
<li>Concatenation of Lists (including strings)
Monoids support <code>fold</code> operations, and similar.</li>
</ul>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Monoid</span>(a<span class="symbol">|</span><span class="type-name">Data</span>)
  mempty <span class="symbol">:</span> a
  (<span class="symbol">&lt;&gt;</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Monoid</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  mempty <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> mempty
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> x[i] <span class="symbol">&lt;&gt;</span> y[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">AndMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span>(<span class="type-name">Bool</span>)
  mempty <span class="symbol">=</span> <span class="type-name">True</span>
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">&amp;&amp;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">OrMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span>(<span class="type-name">Bool</span>)
  mempty <span class="symbol">=</span> <span class="type-name">False</span>
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">||</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">AddMonoid</span>(a<span class="symbol">|</span><span class="type-name">Add</span>) <span class="symbol">-&gt;</span> <span class="type-name">Monoid</span>(a)
  mempty <span class="symbol">=</span> zero
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">+</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">MulMonoid</span>(a<span class="symbol">|</span><span class="type-name">Mul</span>) <span class="symbol">-&gt;</span> <span class="type-name">Monoid</span>(a)
  mempty <span class="symbol">=</span> one
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">*</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Effects</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Ref</span>(r<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">-&gt;</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Ref</span>(r<span class="symbol">,</span> a)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get(ref<span class="symbol">:</span><span class="type-name">Ref</span> h s)       <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} s  <span class="keyword">given</span> (h<span class="symbol">,</span> s) <span class="symbol">=</span> %get(ref)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">:=</span>)(ref<span class="symbol">:</span><span class="type-name">Ref</span> h s<span class="symbol">,</span> x<span class="command">:s</span>) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} () <span class="keyword">given</span> (h<span class="symbol">,</span> s) <span class="symbol">=</span> %put(ref<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ask(ref<span class="symbol">:</span><span class="type-name">Ref</span> h r) <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h} r <span class="keyword">given</span> (h<span class="symbol">,</span> r) <span class="symbol">=</span> %ask(ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">AccumMonoidData</span>(h<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> w<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">=</span> <span class="type-name">UnsafeMkAccumMonoidData</span>(b<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> <span class="type-name">Monoid</span> b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">AccumMonoid</span>(h<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> w)
  getAccumMonoidData <span class="symbol">:</span> <span class="type-name">AccumMonoidData</span>(h<span class="symbol">,</span> w)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> n<span class="symbol">=&gt;</span>w) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> h<span class="symbol">,</span> w) (am<span class="symbol">:</span><span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> w))
  getAccumMonoidData <span class="symbol">=</span>
    <span class="type-name">UnsafeMkAccumMonoidData</span>(b<span class="symbol">,</span> bm) <span class="symbol">=</span> %applyMethod0(am)
    <span class="type-name">UnsafeMkAccumMonoidData</span>(b<span class="symbol">,</span> bm)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+=</span>)(ref<span class="symbol">:</span><span class="type-name">Ref</span> h w<span class="symbol">,</span> x<span class="command">:w</span>) <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h} ()
  <span class="keyword">given</span> (h<span class="symbol">,</span> w) (am<span class="symbol">:</span><span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> w)) <span class="symbol">=</span>
  <span class="type-name">UnsafeMkAccumMonoidData</span>(b<span class="symbol">,</span> bm) <span class="symbol">=</span> %applyMethod0(am)
  empty <span class="symbol">=</span> %applyMethod0(bm)
  %mextend(ref<span class="symbol">,</span> empty<span class="symbol">,</span> <span class="symbol">\</span>x<span class="command">:b</span> y<span class="command">:b</span><span class="symbol">.</span> %applyMethod1(bm<span class="symbol">,</span> x<span class="symbol">,</span> y)<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">!</span>)(ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (n<span class="symbol">=&gt;</span>a)<span class="symbol">,</span> i<span class="command">:n</span>) <span class="symbol">-&gt;</span> <span class="type-name">Ref</span> h a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> h) <span class="symbol">=</span> %indexRef(ref<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst_ref(ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a<span class="symbol">,</span>b)) <span class="symbol">-&gt;</span> <span class="type-name">Ref</span> h a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> b<span class="symbol">,</span> h) <span class="symbol">=</span> %fstRef(ref)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd_ref(ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a<span class="symbol">,</span>b)) <span class="symbol">-&gt;</span> <span class="type-name">Ref</span> h b <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> h) <span class="symbol">=</span> %sndRef(ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> run_reader(
    init<span class="command">:r</span><span class="symbol">,</span>
    action<span class="symbol">:</span>(<span class="keyword">given</span> (h)<span class="symbol">,</span> <span class="type-name">Ref</span> h r) <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a  <span class="keyword">given</span> (r<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> a<span class="symbol">,</span> eff) <span class="symbol">=</span>
  <span class="keyword">def</span> explicitAction(h&#39;<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; r) <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
  %runReader(init<span class="symbol">,</span> explicitAction)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_reader(
    init<span class="command">:r</span><span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="keyword">given</span> (h)<span class="symbol">,</span> <span class="type-name">Ref</span>(h<span class="symbol">,</span>r)) <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a  <span class="keyword">given</span> (r<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> a<span class="symbol">,</span> eff) <span class="symbol">=</span>
  run_reader(init<span class="symbol">,</span> action)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">MonoidLifter</span>(b<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> w<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">-&gt;</span> <span class="type-name">Type</span> <span class="symbol">=</span>
  (<span class="keyword">given</span> (h) (<span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> b))) <span class="symbol">-&gt;&gt;</span> <span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> w)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> mk_accum_monoid (<span class="keyword">given</span> (h<span class="symbol">,</span> w)<span class="symbol">,</span> d<span class="symbol">:</span><span class="type-name">AccumMonoidData</span>(h<span class="symbol">,</span> w)) <span class="symbol">-&gt;</span> <span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> w)
  getAccumMonoidData <span class="symbol">=</span> d
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> run_accum(
    bm<span class="symbol">:</span><span class="type-name">Monoid</span> b<span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="keyword">given</span> (h) (<span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> b))<span class="symbol">,</span> <span class="type-name">Ref</span> h w) <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} (a<span class="symbol">,</span> w)  <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> w<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) (<span class="type-name">MonoidLifter</span>(b<span class="symbol">,</span>w)) <span class="symbol">=</span>
  empty <span class="symbol">=</span> %applyMethod0(bm)
  <span class="keyword">def</span> explicitAction(h&#39;<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; w) <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    accumMonoidData <span class="symbol">:</span> <span class="type-name">AccumMonoidData</span> h&#39; b <span class="symbol">=</span> <span class="type-name">UnsafeMkAccumMonoidData</span> b bm
    accumBaseMonoid <span class="symbol">=</span> mk_accum_monoid accumMonoidData
    %explicitApply(action<span class="symbol">,</span> h&#39;<span class="symbol">,</span> accumBaseMonoid<span class="symbol">,</span> ref)
  %runWriter(empty<span class="symbol">,</span> <span class="symbol">\</span>x<span class="command">:b</span> y<span class="command">:b</span><span class="symbol">.</span> %applyMethod1(bm<span class="symbol">,</span> x<span class="symbol">,</span> y)<span class="symbol">,</span> explicitAction)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> yield_accum(
    m<span class="symbol">:</span><span class="type-name">Monoid</span> b<span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="keyword">given</span> (h) (<span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> b))<span class="symbol">,</span> <span class="type-name">Ref</span> h w) <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} w  <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> w<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) (<span class="type-name">MonoidLifter</span> b w) <span class="symbol">=</span>
  snd <span class="symbol">$</span> run_accum(m<span class="symbol">,</span> action)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> run_state(
    init<span class="command">:s</span><span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="keyword">given</span> (h)<span class="symbol">,</span> <span class="type-name">Ref</span> h s) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} (a<span class="symbol">,</span>s)  <span class="keyword">given</span> (a<span class="symbol">,</span> s<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) <span class="symbol">=</span>
  <span class="keyword">def</span> explicitAction(h&#39;<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; s) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
  %runState(init<span class="symbol">,</span> explicitAction)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_state(
    init<span class="command">:s</span><span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="keyword">given</span> (h)<span class="symbol">,</span> <span class="type-name">Ref</span> h s) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a  <span class="keyword">given</span> (a<span class="symbol">,</span> s<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) <span class="symbol">=</span>
  fst <span class="symbol">$</span> run_state(init<span class="symbol">,</span> action)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> yield_state(
    init<span class="command">:s</span><span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="keyword">given</span> (h)<span class="symbol">,</span> <span class="type-name">Ref</span> h s) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} s  <span class="keyword">given</span> (a<span class="symbol">,</span> s<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) <span class="symbol">=</span>
  snd <span class="symbol">$</span> run_state(init<span class="symbol">,</span> action)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_io(
    f<span class="symbol">:</span>()<span class="symbol">-&gt;</span>{<span class="type-name">IO</span><span class="symbol">|</span>eff} a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a  <span class="keyword">given</span> (a<span class="symbol">,</span> eff)  <span class="symbol">=</span>
  f&#39; <span class="symbol">:</span> (() <span class="symbol">-&gt;</span> {<span class="type-name">IO</span><span class="symbol">|</span>eff} a) <span class="symbol">=</span> <span class="symbol">\.</span> f()
  %runIO(f&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unreachable() <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span> %throwError(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Type classes</h2>
</div></div><div class="cell"><div class="prose-block"><h3>Eq and Ord</h3>
</div></div><div class="cell"><div class="prose-block"><h4>Eq</h4>
<p>Equatable.
Things that we can tell if they are equal or not to other things.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Eq</span>(a<span class="symbol">|</span><span class="type-name">Data</span>)
  (<span class="symbol">==</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/=</span>)(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Eq</span>) <span class="symbol">=</span> not <span class="symbol">$</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Ord</h4>
<p>Orderable / Comparable.
Things that can be place in a total order.
i.e. things that can be compared to other things to find if larger, smaller or equal in value.</p>
</div></div><div class="cell"><div class="prose-block"><p>We take the standard false-hood and pretend that this applies to Floats, even though strictly speaking this not true as our floats follow <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE754</a>, and thus have <code>NaN &lt; 1.0 == false</code> and <code>1.0 &lt; NaN == false</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Ord</span>(a<span class="symbol">|</span><span class="type-name">Eq</span>)
  (<span class="symbol">&gt;</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;=</span>)(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> x<span class="symbol">&lt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;=</span>)(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> x<span class="symbol">&gt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %feq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %feq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ieq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ieq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ieq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ieq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ieq(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Bool</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> b_to_w8 x <span class="symbol">==</span> b_to_w8 y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(())
  <span class="keyword">def</span> (<span class="symbol">==</span>)(_<span class="symbol">,</span> _) <span class="symbol">=</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Either</span>(a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Eq</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Eq</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>(x) <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Left</span>( y) <span class="symbol">-&gt;</span> x <span class="symbol">==</span> y
      <span class="type-name">Right</span>(y) <span class="symbol">-&gt;</span> <span class="type-name">False</span>
    <span class="type-name">Right</span>(x) <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Left</span>( y) <span class="symbol">-&gt;</span> <span class="type-name">False</span>
      <span class="type-name">Right</span>(y) <span class="symbol">-&gt;</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Maybe</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Eq</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Just</span>(x) <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Just</span>(y) <span class="symbol">-&gt;</span> x <span class="symbol">==</span> y
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">False</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> y <span class="keyword">of</span>
      <span class="type-name">Just</span>(y) <span class="symbol">-&gt;</span> <span class="type-name">False</span>
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">RawPtr</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> raw_ptr_to_i64 x <span class="symbol">==</span> raw_ptr_to_i64 y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %fgt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %flt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %fgt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %flt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %igt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ilt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %igt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ilt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %igt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ilt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %igt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ilt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Word64</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %igt(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> w8_to_b <span class="symbol">$</span> %ilt(x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(())
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> <span class="type-name">False</span>
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Eq</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Eq</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(p1<span class="symbol">,</span> p2) <span class="symbol">=</span>
    (x1<span class="symbol">,</span> y1) <span class="symbol">=</span> p1
    (x2<span class="symbol">,</span> y2) <span class="symbol">=</span> p2
    x1 <span class="symbol">==</span> x2 <span class="symbol">&amp;&amp;</span> y1 <span class="symbol">==</span> y2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ord</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ord</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(p1<span class="symbol">,</span> p2) <span class="symbol">=</span>
    (x1<span class="symbol">,</span> y1) <span class="symbol">=</span> p1
    (x2<span class="symbol">,</span> y2) <span class="symbol">=</span> p2
    x1 <span class="symbol">&gt;</span> x2 <span class="symbol">||</span> (x1 <span class="symbol">==</span> x2 <span class="symbol">&amp;&amp;</span> y1 <span class="symbol">&gt;</span> y2)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(p1<span class="symbol">,</span> p2) <span class="symbol">=</span>
    (x1<span class="symbol">,</span> y1) <span class="symbol">=</span> p1
    (x2<span class="symbol">,</span> y2) <span class="symbol">=</span> p2
    x1 <span class="symbol">&lt;</span> x2 <span class="symbol">||</span> (x1 <span class="symbol">==</span> x2 <span class="symbol">&amp;&amp;</span> y1 <span class="symbol">&lt;</span> y2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Ordering</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> o_to_w8 x <span class="symbol">==</span> o_to_w8 y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> nat_to_rep x <span class="symbol">==</span> nat_to_rep y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> nat_to_rep x <span class="symbol">&gt;</span> nat_to_rep y
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> nat_to_rep x <span class="symbol">&lt;</span> nat_to_rep y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want Eq and Ord for all index sets, not just `Fin n`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">Fin</span> n) <span class="keyword">given</span> (n)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> ordinal x <span class="symbol">==</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">Fin</span> n) <span class="keyword">given</span> (n)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> ordinal x <span class="symbol">&gt;</span> ordinal y
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> ordinal x <span class="symbol">&lt;</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">Bool</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> 2
  <span class="keyword">def</span> ordinal(b) <span class="symbol">=</span> <span class="keyword">case</span> b <span class="keyword">of</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> 0
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> 1
  <span class="keyword">def</span> unsafe_from_ordinal(i) <span class="symbol">=</span> i <span class="symbol">&gt;</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">Maybe</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> size a <span class="symbol">+</span> 1
  <span class="keyword">def</span> ordinal(i) <span class="symbol">=</span> <span class="keyword">case</span> i <span class="keyword">of</span>
    <span class="type-name">Just</span>(ai) <span class="symbol">-&gt;</span> ordinal ai
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> size a
  <span class="keyword">def</span> unsafe_from_ordinal(o) <span class="symbol">=</span>
    <span class="keyword">case</span> o <span class="symbol">==</span> size a <span class="keyword">of</span>
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> unsafe_from_ordinal o
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>(<span class="type-name">Bool</span>)
  first_ix <span class="symbol">=</span> unsafe_from_ordinal 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>((a<span class="symbol">,</span>b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">NonEmpty</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">NonEmpty</span>)
  first_ix <span class="symbol">=</span> unsafe_from_ordinal 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>(<span class="type-name">Either</span>(a<span class="symbol">,</span>b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">NonEmpty</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span>)
  first_ix <span class="symbol">=</span> unsafe_from_ordinal 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- The below instance is valid, but causes &quot;multiple candidate dictionaries&quot;
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- errors if both Left and Right are NonEmpty.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- instance NonEmpty (a|b) given {a b} [Ix a, NonEmpty b]
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--  first_ix = unsafe_from_ordinal _ 0
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>(<span class="type-name">Maybe</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span>)
  first_ix <span class="symbol">=</span> unsafe_from_ordinal 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan(
    init<span class="command">:a</span><span class="symbol">,</span>
    body<span class="symbol">:</span>(n<span class="symbol">,</span> a)<span class="symbol">-&gt;</span>(a<span class="symbol">,</span>b)
    ) <span class="symbol">-&gt;</span> (a<span class="symbol">,</span> n<span class="symbol">=&gt;</span>b)  <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> b<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  swap <span class="symbol">$</span> run_state(init) <span class="symbol">\</span>s<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    c <span class="symbol">=</span> get s
    (c&#39;<span class="symbol">,</span> y) <span class="symbol">=</span> body(i<span class="symbol">,</span> c)
    s <span class="symbol">:=</span> c&#39;
    y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fold(init<span class="command">:a</span><span class="symbol">,</span> body<span class="symbol">:</span>(n<span class="symbol">,</span>a)<span class="symbol">-&gt;</span>a) <span class="symbol">-&gt;</span> a  <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  fst <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> (body(i<span class="symbol">,</span> x)<span class="symbol">,</span> ())
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> compare(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Ordering</span> <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span>
  <span class="keyword">if</span> x <span class="symbol">&lt;</span> y
    <span class="keyword">then</span> <span class="type-name">LT</span>
    <span class="keyword">else</span> <span class="keyword">if</span> x <span class="symbol">==</span> y
      <span class="keyword">then</span> <span class="type-name">EQ</span>
      <span class="keyword">else</span> <span class="type-name">GT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span>(<span class="type-name">Ordering</span>)
  mempty <span class="symbol">=</span> <span class="type-name">EQ</span>
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span>
    <span class="keyword">case</span> x <span class="keyword">of</span>
      <span class="type-name">LT</span> <span class="symbol">-&gt;</span> <span class="type-name">LT</span>
      <span class="type-name">GT</span> <span class="symbol">-&gt;</span> <span class="type-name">GT</span>
      <span class="type-name">EQ</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Eq</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span>
    yield_accum <span class="type-name">AndMonoid</span> <span class="symbol">\</span>ref<span class="symbol">.</span>
      <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs[i] <span class="symbol">==</span> ys[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Ord</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span>
    f<span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
        fold <span class="type-name">EQ</span> <span class="symbol">$</span> <span class="symbol">\</span>i c<span class="symbol">.</span> c <span class="symbol">&lt;&gt;</span> compare(xs[i]<span class="symbol">,</span> ys[i])
    f <span class="symbol">==</span> <span class="type-name">GT</span>
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span>
    f<span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
        fold <span class="type-name">EQ</span> <span class="symbol">$</span> <span class="symbol">\</span>i c<span class="symbol">.</span> c <span class="symbol">&lt;&gt;</span> compare(xs[i]<span class="symbol">,</span> ys[i])
    f <span class="symbol">==</span> <span class="type-name">LT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Subset class</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Subset</span>(subset<span class="symbol">,</span> superset)
  inject&#39;         <span class="symbol">:</span> (subset) <span class="symbol">-&gt;</span> superset
  project&#39;        <span class="symbol">:</span> (superset) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> subset
  unsafe_project&#39; <span class="symbol">:</span> (superset) <span class="symbol">-&gt;</span> subset
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- wrappers with more helpful implicit arg names
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inject(x<span class="command">:from</span>)         <span class="symbol">-&gt;</span> to       <span class="keyword">given</span> (to<span class="symbol">,</span> from) (<span class="type-name">Subset</span>(from<span class="symbol">,</span> to)) <span class="symbol">=</span> inject&#39;(x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> project(x<span class="command">:from</span>)        <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> to <span class="keyword">given</span> (to<span class="symbol">,</span> from) (<span class="type-name">Subset</span>(to<span class="symbol">,</span> from)) <span class="symbol">=</span> project&#39;(x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_project(x<span class="command">:from</span>) <span class="symbol">-&gt;</span> to       <span class="keyword">given</span> (to<span class="symbol">,</span> from) (<span class="type-name">Subset</span>(to<span class="symbol">,</span> from)) <span class="symbol">=</span> unsafe_project&#39;(x)
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(a<span class="symbol">,</span> c) <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> c) (<span class="type-name">Subset</span>(a<span class="symbol">,</span> b)<span class="symbol">,</span> <span class="type-name">Subset</span>(b<span class="symbol">,</span> c))
  <span class="keyword">def</span> inject&#39;(x) <span class="symbol">=</span> inject <span class="symbol">$</span> inject(to<span class="symbol">=</span>b<span class="symbol">,</span> x)
  <span class="keyword">def</span> project&#39;(x) <span class="symbol">=</span> <span class="keyword">case</span> project(to<span class="symbol">=</span>b<span class="symbol">,</span> x) <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span>(y)<span class="symbol">-&gt;</span> project y
  <span class="keyword">def</span> unsafe_project&#39;(x) <span class="symbol">=</span> unsafe_project <span class="symbol">$</span> unsafe_project(to<span class="symbol">=</span>b<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_project_rangefrom(j<span class="command">:q</span>) <span class="symbol">-&gt;</span> <span class="type-name">RangeFrom</span>(q<span class="symbol">,</span> i) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>) <span class="symbol">=</span>
  <span class="type-name">RangeFrom</span><span class="symbol">.</span>new unsafe_nat_diff(ordinal j<span class="symbol">,</span> ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">RangeFrom</span>(q<span class="symbol">,</span> i)<span class="symbol">,</span> q) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> inject&#39;(j) <span class="symbol">=</span>
    unsafe_from_ordinal <span class="symbol">$</span> j<span class="symbol">.</span>val <span class="symbol">+</span> ordinal i
  <span class="keyword">def</span> project&#39;(j) <span class="symbol">=</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&lt;</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">RangeFrom</span><span class="symbol">.</span>new <span class="symbol">$</span> unsafe_nat_diff(j&#39;<span class="symbol">,</span> i&#39;)
  <span class="keyword">def</span> unsafe_project&#39;(j) <span class="symbol">=</span> <span class="type-name">RangeFrom</span><span class="symbol">.</span>new unsafe_nat_diff(ordinal j<span class="symbol">,</span> ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">RangeFromExc</span>(q<span class="symbol">,</span> i)<span class="symbol">,</span> q) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> inject&#39;(j) <span class="symbol">=</span> unsafe_from_ordinal <span class="symbol">$</span> j<span class="symbol">.</span>val <span class="symbol">+</span> ordinal i <span class="symbol">+</span> 1
  <span class="keyword">def</span> project&#39;(j) <span class="symbol">=</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&lt;=</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">RangeFromExc</span><span class="symbol">.</span>new unsafe_nat_diff(j&#39;<span class="symbol">,</span> i&#39; <span class="symbol">+</span> 1)
  <span class="keyword">def</span> unsafe_project&#39;(j) <span class="symbol">=</span>
    <span class="type-name">RangeFromExc</span><span class="symbol">.</span>new unsafe_nat_diff(ordinal j<span class="symbol">,</span> ordinal i <span class="symbol">+</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">RangeTo</span>(q<span class="symbol">,</span> i)<span class="symbol">,</span> q) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> inject&#39;(j) <span class="symbol">=</span> unsafe_from_ordinal j<span class="symbol">.</span>val
  <span class="keyword">def</span> project&#39;(j) <span class="symbol">=</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&gt;</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">RangeTo</span><span class="symbol">.</span>new j&#39;
  <span class="keyword">def</span> unsafe_project&#39;(j) <span class="symbol">=</span> <span class="type-name">RangeTo</span><span class="symbol">.</span>new (ordinal j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">RangeToExc</span>(q<span class="symbol">,</span> i)<span class="symbol">,</span> q) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> inject&#39;(j) <span class="symbol">=</span> unsafe_from_ordinal j<span class="symbol">.</span>val
  <span class="keyword">def</span> project&#39;(j) <span class="symbol">=</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&gt;=</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">RangeToExc</span><span class="symbol">.</span>new j&#39;
  <span class="keyword">def</span> unsafe_project&#39;(j) <span class="symbol">=</span> <span class="type-name">RangeToExc</span><span class="symbol">.</span>new (ordinal j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">RangeToExc</span>(q<span class="symbol">,</span> i)<span class="symbol">,</span> <span class="type-name">RangeTo</span>(q<span class="symbol">,</span> i)) <span class="keyword">given</span> (q<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="command">:q</span>)
  <span class="keyword">def</span> inject&#39;(j) <span class="symbol">=</span> unsafe_from_ordinal j<span class="symbol">.</span>val
  <span class="keyword">def</span> project&#39;(j) <span class="symbol">=</span>
    j&#39; <span class="symbol">=</span> ordinal j
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">if</span> j&#39; <span class="symbol">&gt;=</span> i&#39;
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">RangeToExc</span><span class="symbol">.</span>new j&#39;
  <span class="keyword">def</span> unsafe_project&#39;(j) <span class="symbol">=</span> <span class="type-name">RangeToExc</span><span class="symbol">.</span>new (ordinal j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Elementary/Special Functions</h2>
<p>This is more or less the standard <a href="https://en.wikipedia.org/wiki/C_mathematical_functions">LibM fare</a>.
Roughly it lines up with some definitions of the set of <a href="https://en.wikipedia.org/wiki/Elementary_function">Elementary</a> and/or <a href="https://en.wikipedia.org/wiki/Special_functions">Special</a>.
In truth, nothing is elementary or special except that we humans have decided it is.
Many, but not all of these functions are <a href="https://en.wikipedia.org/wiki/Transcendental_function">Transcendental</a>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Floating</span>(a<span class="symbol">:</span><span class="type-name">Type</span>)
  exp    <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  exp2   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  log    <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  log2   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  log10  <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  log1p  <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  sin    <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  cos    <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  tan    <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  sinh   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  cosh   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  tanh   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  floor  <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  ceil   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  round  <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  sqrt   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  pow    <span class="symbol">:</span> (a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> a
  lgamma <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  erf    <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
  erfc   <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lbeta(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">|</span><span class="type-name">Floating</span>) <span class="symbol">=</span> lgamma x <span class="symbol">+</span> lgamma y <span class="symbol">-</span> lgamma (x <span class="symbol">+</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: better numerics for very large and small values.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- Using %exp here to avoid circular definition problems.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_sinh(x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv(%fsub(%exp(x)<span class="symbol">,</span> %exp(%fsub(0<span class="symbol">.</span>0<span class="symbol">,</span>x)))<span class="symbol">,</span> 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_cosh(x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv(%fadd(%exp(x)<span class="symbol">,</span> %exp(%fsub(0<span class="symbol">.</span>0<span class="symbol">,</span>x)))<span class="symbol">,</span> 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_tanh(x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv(%fsub(%exp(x)<span class="symbol">,</span> %exp(%fsub(0<span class="symbol">.</span>0<span class="symbol">,</span>x)))
                                               <span class="symbol">,</span>%fadd(%exp(x)<span class="symbol">,</span> %exp(%fsub(0<span class="symbol">.</span>0<span class="symbol">,</span>x))))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: unify this with float32 functions.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_sinh(x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv(%fsub(%exp(x)<span class="symbol">,</span> %exp(%fsub(f_to_f64 0<span class="symbol">.</span>0<span class="symbol">,</span> x)))<span class="symbol">,</span> f_to_f64 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_cosh(x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv(%fadd(%exp(x)<span class="symbol">,</span> %exp(%fsub(f_to_f64 0<span class="symbol">.</span>0<span class="symbol">,</span> x)))<span class="symbol">,</span> f_to_f64 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_tanh(x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv(%fsub(%exp(x)<span class="symbol">,</span> %exp(%fsub(f_to_f64 0<span class="symbol">.</span>0<span class="symbol">,</span> x)))
                                               <span class="symbol">,</span>%fadd(%exp(x)<span class="symbol">,</span> %exp(%fsub(f_to_f64 0<span class="symbol">.</span>0<span class="symbol">,</span> x))))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> exp(x)   <span class="symbol">=</span> %exp(x)
  <span class="keyword">def</span> exp2(x)  <span class="symbol">=</span> %exp2(x)
  <span class="keyword">def</span> log(x)   <span class="symbol">=</span> %log(x)
  <span class="keyword">def</span> log2(x)  <span class="symbol">=</span> %log2(x)
  <span class="keyword">def</span> log10(x) <span class="symbol">=</span> %log10(x)
  <span class="keyword">def</span> log1p(x) <span class="symbol">=</span> %log1p(x)
  <span class="keyword">def</span> sin(x)   <span class="symbol">=</span> %sin(x)
  <span class="keyword">def</span> cos(x)   <span class="symbol">=</span> %cos(x)
  <span class="keyword">def</span> tan(x)   <span class="symbol">=</span> %tan(    x)
  <span class="keyword">def</span> sinh(x)  <span class="symbol">=</span> float64_sinh(x)
  <span class="keyword">def</span> cosh(x)  <span class="symbol">=</span> float64_cosh(x)
  <span class="keyword">def</span> tanh(x)  <span class="symbol">=</span> float64_tanh(x)
  <span class="keyword">def</span> floor(x) <span class="symbol">=</span> %floor(x)
  <span class="keyword">def</span> ceil(x)  <span class="symbol">=</span> %ceil(x)
  <span class="keyword">def</span> round(x) <span class="symbol">=</span> %round(x)
  <span class="keyword">def</span> sqrt(x)  <span class="symbol">=</span> %sqrt(x)
  <span class="keyword">def</span> pow(x<span class="symbol">,</span>y) <span class="symbol">=</span> %fpow(x<span class="symbol">,</span>y)
  <span class="keyword">def</span> lgamma(x)<span class="symbol">=</span> %lgamma(x)
  <span class="keyword">def</span> erf(x)   <span class="symbol">=</span> %erf(x)
  <span class="keyword">def</span> erfc(x)  <span class="symbol">=</span> %erfc(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> exp(x)   <span class="symbol">=</span> %exp(x)
  <span class="keyword">def</span> exp2(x)  <span class="symbol">=</span> %exp2(x)
  <span class="keyword">def</span> log(x)   <span class="symbol">=</span> %log(x)
  <span class="keyword">def</span> log2(x)  <span class="symbol">=</span> %log2(x)
  <span class="keyword">def</span> log10(x) <span class="symbol">=</span> %log10(x)
  <span class="keyword">def</span> log1p(x) <span class="symbol">=</span> %log1p(x)
  <span class="keyword">def</span> sin(x)   <span class="symbol">=</span> %sin(x)
  <span class="keyword">def</span> cos(x)   <span class="symbol">=</span> %cos(x)
  <span class="keyword">def</span> tan(x)   <span class="symbol">=</span> %tan(x)
  <span class="keyword">def</span> sinh(x)  <span class="symbol">=</span> float32_sinh(x)
  <span class="keyword">def</span> cosh(x)  <span class="symbol">=</span> float32_cosh(x)
  <span class="keyword">def</span> tanh(x)  <span class="symbol">=</span> float32_tanh(x)
  <span class="keyword">def</span> floor(x) <span class="symbol">=</span> %floor(x)
  <span class="keyword">def</span> ceil(x)  <span class="symbol">=</span> %ceil(x)
  <span class="keyword">def</span> round(x) <span class="symbol">=</span> %round(x)
  <span class="keyword">def</span> sqrt(x)  <span class="symbol">=</span> %sqrt(x)
  <span class="keyword">def</span> pow(x<span class="symbol">,</span>y) <span class="symbol">=</span> %fpow(x<span class="symbol">,</span> y)
  <span class="keyword">def</span> lgamma(x)<span class="symbol">=</span> %lgamma(x)
  <span class="keyword">def</span> erf(x)   <span class="symbol">=</span> %erf(x)
  <span class="keyword">def</span> erfc(x)  <span class="symbol">=</span> %erfc(x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Raw pointer operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">Ptr</span>(a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">=</span>
  val <span class="symbol">:</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cast_ptr(ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Ptr</span> b <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new(ptr<span class="symbol">.</span>val)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Storable</span>(a<span class="symbol">|</span><span class="type-name">Data</span>)
  store <span class="symbol">:</span> (<span class="type-name">Ptr</span> a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} ()
  load  <span class="symbol">:</span> (<span class="type-name">Ptr</span> a)    <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a
  storage_size <span class="symbol">:</span> () <span class="symbol">-&gt;</span> <span class="type-name">Nat</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span>(<span class="type-name">Word8</span>)
  <span class="keyword">def</span> store(ptr<span class="symbol">,</span> x) <span class="symbol">=</span> %ptrStore(ptr<span class="symbol">.</span>val<span class="symbol">,</span> x)
  <span class="keyword">def</span> load(ptr) <span class="symbol">=</span> %ptrLoad(ptr<span class="symbol">.</span>val)
  <span class="keyword">def</span> storage_size() <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> store(ptr<span class="symbol">,</span> x) <span class="symbol">=</span> %ptrStore(internal_cast(to<span class="symbol">=</span>%<span class="type-name">Int32Ptr</span>()<span class="symbol">,</span> ptr<span class="symbol">.</span>val)<span class="symbol">,</span> x)
  <span class="keyword">def</span> load(ptr) <span class="symbol">=</span> %ptrLoad(internal_cast(to<span class="symbol">=</span>%<span class="type-name">Int32Ptr</span>()<span class="symbol">,</span> ptr<span class="symbol">.</span>val))
  <span class="keyword">def</span> storage_size() <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span>(<span class="type-name">Word32</span>)
  <span class="keyword">def</span> store(ptr<span class="symbol">,</span> x) <span class="symbol">=</span> %ptrStore(internal_cast(to<span class="symbol">=</span>%<span class="type-name">Word32Ptr</span>()<span class="symbol">,</span> ptr)<span class="symbol">,</span> x)
  <span class="keyword">def</span> load(ptr) <span class="symbol">=</span> %ptrLoad(internal_cast(to<span class="symbol">=</span>%<span class="type-name">Word32Ptr</span>()<span class="symbol">,</span> ptr))
  <span class="keyword">def</span> storage_size() <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> store(ptr<span class="symbol">,</span> x) <span class="symbol">=</span> %ptrStore(internal_cast(to<span class="symbol">=</span>%<span class="type-name">Float32Ptr</span>()<span class="symbol">,</span> ptr<span class="symbol">.</span>val)<span class="symbol">,</span> x)
  <span class="keyword">def</span> load(ptr) <span class="symbol">=</span> %ptrLoad(internal_cast(to<span class="symbol">=</span>%<span class="type-name">Float32Ptr</span>()<span class="symbol">,</span> ptr<span class="symbol">.</span>val))
  <span class="keyword">def</span> storage_size() <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> store(ptr<span class="symbol">,</span> x) <span class="symbol">=</span> store(<span class="type-name">Ptr</span><span class="symbol">.</span>new(ptr<span class="symbol">.</span>val)<span class="symbol">,</span> nat_to_rep x)
  <span class="keyword">def</span> load(ptr) <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> load(<span class="type-name">Ptr</span><span class="symbol">.</span>new(ptr<span class="symbol">.</span>val))
  <span class="keyword">def</span> storage_size() <span class="symbol">=</span> storage_size(a<span class="symbol">=</span><span class="type-name">NatRep</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span>(<span class="type-name">Ptr</span> a) <span class="keyword">given</span> (a)
  <span class="keyword">def</span> store(ptr<span class="symbol">,</span> x) <span class="symbol">=</span> %ptrStore(internal_cast(to<span class="symbol">=</span>%<span class="type-name">PtrPtr</span>()<span class="symbol">,</span> ptr<span class="symbol">.</span>val)<span class="symbol">,</span> x<span class="symbol">.</span>val)
  <span class="keyword">def</span> load(ptr) <span class="symbol">=</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new(%ptrLoad(internal_cast(to<span class="symbol">=</span>%<span class="type-name">PtrPtr</span>()<span class="symbol">,</span> ptr)))
  <span class="keyword">def</span> storage_size() <span class="symbol">=</span> 8  <span class="comment">-- TODO: something more portable?
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Storable instances for other types
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> malloc(n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Ptr</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>)  <span class="symbol">=</span>
  numBytes <span class="symbol">=</span> storage_size(a<span class="symbol">=</span>a) <span class="symbol">*</span> n
  <span class="type-name">Ptr</span><span class="symbol">.</span>new(%alloc(nat_to_rep numBytes))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> free(ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="keyword">given</span> (a) <span class="symbol">=</span> %free(ptr<span class="symbol">.</span>val)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+&gt;&gt;</span>)(ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a<span class="symbol">,</span> i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Ptr</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>) <span class="symbol">=</span>
  i&#39; <span class="symbol">=</span> nat_to_rep <span class="symbol">$</span> i <span class="symbol">*</span> storage_size(a<span class="symbol">=</span>a)
  <span class="type-name">Ptr</span><span class="symbol">.</span>new(%ptrOffset(ptr<span class="symbol">.</span>val<span class="symbol">,</span> i&#39;))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: consider making a Storable instance for tables instead
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> store_table(ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> a<span class="symbol">,</span> tab<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">for</span>_ i<span class="symbol">.</span> store(ptr <span class="symbol">+&gt;&gt;</span> ordinal i<span class="symbol">,</span> tab[i])
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> memcpy(dest<span class="symbol">:</span><span class="type-name">Ptr</span> a<span class="symbol">,</span> src<span class="symbol">:</span><span class="type-name">Ptr</span> a<span class="symbol">,</span> n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>) <span class="symbol">=</span>
  <span class="keyword">for</span>_ i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    store(dest <span class="symbol">+&gt;&gt;</span> i&#39;<span class="symbol">,</span> load <span class="symbol">$</span> src <span class="symbol">+&gt;&gt;</span> i&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: generalize these brackets to allow other effects
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: make sure that freeing happens even if there are run-time errors
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_alloc(
    n<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="type-name">Ptr</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b
    ) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b  <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span><span class="symbol">,</span>  b) <span class="symbol">=</span>
  ptr <span class="symbol">=</span> malloc n
  result <span class="symbol">=</span> action ptr
  free ptr
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_table_ptr(
    xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="type-name">Ptr</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b
    ) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b  <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span><span class="symbol">,</span> b<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  ptr <span class="symbol">&lt;-</span> with_alloc(size n)
  <span class="keyword">for</span> i<span class="symbol">.</span> store(ptr <span class="symbol">+&gt;&gt;</span> ordinal i<span class="symbol">,</span> xs[i])
  action ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> table_from_ptr(ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> load <span class="symbol">$</span> ptr <span class="symbol">+&gt;&gt;</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Miscellaneous common utilities</h2>
</div></div><div class="cell"><div class="code-block">pi <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> 3<span class="symbol">.</span>141592653589793
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> id(x<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a) <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dup(x<span class="command">:a</span>) <span class="symbol">-&gt;</span> (a<span class="symbol">,</span> a) <span class="keyword">given</span> (a) <span class="symbol">=</span> (x<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> map(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>{<span class="symbol">|</span>eff} b<span class="symbol">,</span> xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} (n<span class="symbol">=&gt;</span>b)  <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> eff) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> f xs[i]
</div></div><div class="cell"><div class="code-block"><span class="comment">-- map, flipped so that the function goes last
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> each(xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a<span class="symbol">,</span> f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>{<span class="symbol">|</span>eff} b) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} (n<span class="symbol">=&gt;</span>b)  <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> eff) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> f xs[i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> zip(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> ys<span class="command">:n</span><span class="symbol">=&gt;</span>b) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span>(a<span class="symbol">,</span>b)) <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (xs[i]<span class="symbol">,</span> ys[i])
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unzip(xys<span class="command">:n</span><span class="symbol">=&gt;</span>(a<span class="symbol">,</span>b)) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span>a <span class="symbol">,</span> n<span class="symbol">=&gt;</span>b) <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)<span class="symbol">=</span> (each xys fst<span class="symbol">,</span> each xys snd)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fanout(x<span class="command">:a</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sq(x<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Mul</span>) <span class="symbol">=</span> x <span class="symbol">*</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> abs(x<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> select(x <span class="symbol">&gt;</span> zero<span class="symbol">,</span> x<span class="symbol">,</span> zero <span class="symbol">-</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mod(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">|</span><span class="type-name">Integral</span>) <span class="symbol">=</span> rem(y <span class="symbol">+</span> rem(x<span class="symbol">,</span> y)<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Table Operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Floating</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> exp(x)       <span class="symbol">=</span> each x exp
  <span class="keyword">def</span> exp2(x)      <span class="symbol">=</span> each x exp2
  <span class="keyword">def</span> log(x)       <span class="symbol">=</span> each x log
  <span class="keyword">def</span> log2(x)      <span class="symbol">=</span> each x log2
  <span class="keyword">def</span> log10(x)     <span class="symbol">=</span> each x log10
  <span class="keyword">def</span> log1p(x)     <span class="symbol">=</span> each x log1p
  <span class="keyword">def</span> sin(x)       <span class="symbol">=</span> each x sin
  <span class="keyword">def</span> cos(x)       <span class="symbol">=</span> each x cos
  <span class="keyword">def</span> tan(x)       <span class="symbol">=</span> each x tan
  <span class="keyword">def</span> sinh(x)      <span class="symbol">=</span> each x sinh
  <span class="keyword">def</span> cosh(x)      <span class="symbol">=</span> each x cosh
  <span class="keyword">def</span> tanh(x)      <span class="symbol">=</span> each x tanh
  <span class="keyword">def</span> floor(x)     <span class="symbol">=</span> each x floor
  <span class="keyword">def</span> ceil(x)      <span class="symbol">=</span> each x ceil
  <span class="keyword">def</span> round(x)     <span class="symbol">=</span> each x round
  <span class="keyword">def</span> sqrt(x)      <span class="symbol">=</span> each x sqrt
  <span class="keyword">def</span> pow(x<span class="symbol">,</span> y)    <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> pow(x[i]<span class="symbol">,</span> y[i])
  <span class="keyword">def</span> lgamma(x)    <span class="symbol">=</span> each x lgamma
  <span class="keyword">def</span> erf(x)       <span class="symbol">=</span> each x erf
  <span class="keyword">def</span> erfc(x)      <span class="symbol">=</span> each x erfc
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Reductions</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `combine` should be a commutative and associative, and form a
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- commutative monoid with `identity`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reduce(identity<span class="command">:a</span><span class="symbol">,</span> combine<span class="symbol">:</span>(a<span class="symbol">,</span>a)<span class="symbol">-&gt;</span>a<span class="symbol">,</span> xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="comment">-- TODO: implement with the accumulator effect
</span>  fold identity <span class="symbol">\</span>i c<span class="symbol">.</span> combine(c<span class="symbol">,</span> xs[i])
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: call this `scan` and call the current `scan` something else
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan&#39;(init<span class="command">:a</span><span class="symbol">,</span> body<span class="symbol">:</span>(n<span class="symbol">,</span>a)<span class="symbol">-&gt;</span>a) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  snd <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> dup(body(i<span class="symbol">,</span> x))
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fsum(xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  yield_accum(<span class="type-name">AddMonoid</span> <span class="type-name">Float</span>) <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs[i]
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sum(xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">-&gt;</span> v <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> v<span class="symbol">|</span><span class="type-name">Add</span>) <span class="symbol">=</span> reduce(zero<span class="symbol">,</span> (<span class="symbol">+</span>)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prod(xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">-&gt;</span> v <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> v<span class="symbol">|</span><span class="type-name">Mul</span>) <span class="symbol">=</span> reduce(one <span class="symbol">,</span> (<span class="symbol">*</span>)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mean(xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">-&gt;</span> v <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> v<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span> sum xs <span class="symbol">/</span> n_to_f (size n)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> std(xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">-&gt;</span> v <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> v<span class="symbol">|</span><span class="type-name">Mul</span><span class="symbol">|</span><span class="type-name">Sub</span><span class="symbol">|</span><span class="type-name">VSpace</span><span class="symbol">|</span><span class="type-name">Floating</span>) <span class="symbol">=</span> sqrt <span class="symbol">$</span> mean (each xs sq) <span class="symbol">-</span> sq (mean xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any(xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> reduce(<span class="type-name">False</span><span class="symbol">,</span> (<span class="symbol">||</span>)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> all(xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> reduce(<span class="type-name">True</span> <span class="symbol">,</span> (<span class="symbol">&amp;&amp;</span>)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>apply_n</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> apply_n(n<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> x<span class="command">:a</span><span class="symbol">,</span> f<span class="symbol">:</span>(a) <span class="symbol">-&gt;</span> a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  yield_state x <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> _<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    ref <span class="symbol">:=</span> f (get ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>cumulative sum</h2>
<p>TODO: Move this to be with reductions?
It's a kind of <code>scan</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cumsum(xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Add</span>) <span class="symbol">=</span>
  total <span class="symbol">&lt;-</span> with_state zero
  <span class="keyword">for</span> i<span class="symbol">.</span>
    newTotal <span class="symbol">=</span> get total <span class="symbol">+</span> xs[i]
    total <span class="symbol">:=</span> newTotal
    newTotal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cumsum_low(xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Add</span>) <span class="symbol">=</span>
  total <span class="symbol">&lt;-</span> with_state zero
  <span class="keyword">for</span> i<span class="symbol">.</span>
    oldTotal <span class="symbol">=</span> get total
    total <span class="symbol">:=</span> oldTotal <span class="symbol">+</span> xs[i]
    oldTotal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Automatic differentiation</h2>
</div></div><div class="cell"><div class="prose-block"><h3>AD operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: add vector space constraints
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearize(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>b<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> (b<span class="symbol">,</span> (a)<span class="symbol">-&gt;</span>b) <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span>
  %linearize(<span class="symbol">\</span>x<span class="symbol">.</span> f x<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> jvp(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>b<span class="symbol">,</span> x<span class="command">:a</span><span class="symbol">,</span> t<span class="command">:a</span>) <span class="symbol">-&gt;</span> b <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span> (snd <span class="symbol">$</span> linearize(f<span class="symbol">,</span> x))(t)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose_linear(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>b) <span class="symbol">-&gt;</span> (b)<span class="symbol">-&gt;</span>a <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span> <span class="symbol">\</span>ct<span class="symbol">.</span>
  %linearTranspose(<span class="symbol">\</span>x<span class="symbol">.</span> f x<span class="symbol">,</span> ct)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vjp(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>b<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> (b<span class="symbol">,</span> (b)<span class="symbol">-&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">,</span> b) <span class="symbol">=</span>
  (y<span class="symbol">,</span> df) <span class="symbol">=</span> linearize(f<span class="symbol">,</span> x)
  (y<span class="symbol">,</span> transpose_linear df)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> grad(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a) <span class="symbol">=</span> (snd vjp(f<span class="symbol">,</span> x))(1<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv(f<span class="symbol">:</span>(<span class="type-name">Float</span>)<span class="symbol">-&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span> jvp(f<span class="symbol">,</span> x<span class="symbol">,</span> 1<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv_rev(f<span class="symbol">:</span>(<span class="type-name">Float</span>)<span class="symbol">-&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span> (snd vjp(f<span class="symbol">,</span> x))(1<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- XXX: Watch out when editing this data type! We depend on its structure
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- deep inside the compiler (mostly in linearization and during rule registration).
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">SymbolicTangent</span>(a) <span class="symbol">=</span>
  <span class="type-name">ZeroTangent</span>
  <span class="type-name">SomeTangent</span>(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> someTangent(x<span class="symbol">:</span><span class="type-name">SymbolicTangent</span> a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">ZeroTangent</span>     <span class="symbol">-&gt;</span> zero
    <span class="type-name">SomeTangent</span>(x&#39;) <span class="symbol">-&gt;</span> x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Approximate Equality</h3>
<p>TODO: move this outside the AD section to be with equality?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasAllClose</span>(a)
  allclose <span class="symbol">:</span> (a<span class="symbol">,</span> a<span class="symbol">,</span> a<span class="symbol">,</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasDefaultTolerance</span>(a)
  default_atol <span class="symbol">:</span> a
  default_rtol <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">~~</span>)(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">HasAllClose</span><span class="symbol">|</span><span class="type-name">HasDefaultTolerance</span>) <span class="symbol">=</span>
  allclose(default_atol<span class="symbol">,</span> default_rtol<span class="symbol">,</span> x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> allclose(atol<span class="symbol">,</span> rtol<span class="symbol">,</span> x<span class="symbol">,</span> y) <span class="symbol">=</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> allclose(atol<span class="symbol">,</span> rtol<span class="symbol">,</span> x<span class="symbol">,</span> y) <span class="symbol">=</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span>(<span class="type-name">Float32</span>)
  default_atol <span class="symbol">=</span> f_to_f32 0<span class="symbol">.</span>00001
  default_rtol <span class="symbol">=</span> f_to_f32 0<span class="symbol">.</span>0001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span>(<span class="type-name">Float64</span>)
  default_atol <span class="symbol">=</span> f_to_f64 0<span class="symbol">.</span>00000001
  default_rtol <span class="symbol">=</span> f_to_f64 0<span class="symbol">.</span>00001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> ( a<span class="symbol">|</span><span class="type-name">HasDefaultTolerance</span><span class="symbol">|</span><span class="type-name">HasAllClose</span>
                                   <span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">HasDefaultTolerance</span><span class="symbol">|</span><span class="type-name">HasAllClose</span>)
  <span class="keyword">def</span> allclose(atol<span class="symbol">,</span> rtol<span class="symbol">,</span> pair1<span class="symbol">,</span> pair2) <span class="symbol">=</span>
    (x1<span class="symbol">,</span> x2) <span class="symbol">=</span> pair1
    (y1<span class="symbol">,</span> y2) <span class="symbol">=</span> pair2
    (x1 <span class="symbol">~~</span> y1) <span class="symbol">&amp;&amp;</span> (x2 <span class="symbol">~~</span> y2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">HasDefaultTolerance</span><span class="symbol">,</span>b<span class="symbol">|</span><span class="type-name">HasDefaultTolerance</span>)
  default_atol <span class="symbol">=</span> (default_atol<span class="symbol">,</span> default_atol)
  default_rtol <span class="symbol">=</span> (default_rtol<span class="symbol">,</span> default_rtol)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span>(n<span class="symbol">=&gt;</span>t) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> t<span class="symbol">|</span><span class="type-name">HasAllClose</span>)
  <span class="keyword">def</span> allclose(atol<span class="symbol">,</span> rtol<span class="symbol">,</span> a<span class="symbol">,</span> b) <span class="symbol">=</span>
    all <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> allclose(atol[i]<span class="symbol">,</span> rtol[i]<span class="symbol">,</span> a[i]<span class="symbol">,</span> b[i])
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span>(n<span class="symbol">=&gt;</span>t) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> t<span class="symbol">|</span><span class="type-name">HasDefaultTolerance</span>)
  default_atol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> default_atol
  default_rtol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> default_rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>AD Checking tools</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> check_deriv_base(f<span class="symbol">:</span>(<span class="type-name">Float</span>)<span class="symbol">-&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  eps <span class="symbol">=</span> 0<span class="symbol">.</span>01
  ansFwd  <span class="symbol">=</span> deriv(     f<span class="symbol">,</span> x)
  ansRev  <span class="symbol">=</span> deriv_rev( f<span class="symbol">,</span> x)
  ansNumeric <span class="symbol">=</span> (f (x <span class="symbol">+</span> eps) <span class="symbol">-</span> f (x <span class="symbol">-</span> eps)) <span class="symbol">/</span> (2<span class="symbol">.</span> <span class="symbol">*</span> eps)
  ansFwd <span class="symbol">~~</span> ansNumeric <span class="symbol">&amp;&amp;</span> ansRev <span class="symbol">~~</span> ansNumeric
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> check_deriv(f<span class="symbol">:</span>(<span class="type-name">Float</span>)<span class="symbol">-&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  check_deriv_base(f<span class="symbol">,</span> x) <span class="symbol">&amp;&amp;</span> check_deriv_base(<span class="symbol">\</span>x<span class="symbol">.</span> deriv(f<span class="symbol">,</span> x)<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Length-erased lists</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">List</span>(a)<span class="symbol">=</span>
  <span class="type-name">AsList</span>(n<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> elements<span class="symbol">:</span>(<span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span>(<span class="type-name">List</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Eq</span>)
  <span class="keyword">def</span> (<span class="symbol">==</span>)(xsList<span class="symbol">,</span> ysList) <span class="symbol">=</span>
    <span class="type-name">AsList</span>(nx<span class="symbol">,</span>xs) <span class="symbol">=</span> xsList
    <span class="type-name">AsList</span>(ny<span class="symbol">,</span>ys) <span class="symbol">=</span> ysList
    <span class="keyword">if</span> nx <span class="symbol">/=</span> ny
      <span class="keyword">then</span> <span class="type-name">False</span>
      <span class="keyword">else</span> all <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nx)<span class="symbol">.</span>
        xs[i] <span class="symbol">==</span> ys[unsafe_from_ordinal (ordinal i)]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_cast_table(xs<span class="command">:from</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> to<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (to<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> from<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs[unsafe_from_ordinal (ordinal i)]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> to_list(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> <span class="type-name">List</span> a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="type-name">AsList</span>(_<span class="symbol">,</span> unsafe_cast_table(to<span class="symbol">=</span><span class="type-name">Fin</span> n&#39;<span class="symbol">,</span> xs))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span>(<span class="type-name">List</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>)
  mempty <span class="symbol">=</span> <span class="type-name">AsList</span>(_<span class="symbol">,</span> [])
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span>
    <span class="type-name">AsList</span>(nx<span class="symbol">,</span>xs) <span class="symbol">=</span> x
    <span class="type-name">AsList</span>(ny<span class="symbol">,</span>ys) <span class="symbol">=</span> y
    nz <span class="symbol">=</span> nx <span class="symbol">+</span> ny
    to_list <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nz)<span class="symbol">.</span>
      i&#39; <span class="symbol">=</span> ordinal i
      <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> nx <span class="keyword">of</span>
        <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs[unsafe_from_ordinal i&#39;]
        <span class="type-name">False</span> <span class="symbol">-&gt;</span> ys[unsafe_from_ordinal <span class="symbol">$</span> unsafe_nat_diff(i&#39;<span class="symbol">,</span> nx)]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">ListMonoid</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">-&gt;</span> <span class="type-name">Monoid</span>(<span class="type-name">List</span> a)
  mempty <span class="symbol">=</span> mempty
  <span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>)(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">&lt;&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO Eliminate or reimplement this operation, since it costs O(n)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- where n is the length of the list held in the reference.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> append(list<span class="symbol">:</span> <span class="type-name">Ref</span>(h<span class="symbol">,</span> <span class="type-name">List</span> a)<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h} ()
      <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> h) (<span class="type-name">AccumMonoid</span>(h<span class="symbol">,</span> <span class="type-name">List</span> a)) <span class="symbol">=</span>
  list <span class="symbol">+=</span> to_list [x]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: replace `slice` with this?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> post_slice(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> start<span class="symbol">:</span><span class="type-name">Post</span> n<span class="symbol">,</span> end<span class="symbol">:</span><span class="type-name">Post</span> n) <span class="symbol">-&gt;</span> <span class="type-name">List</span> a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  slice_size <span class="symbol">=</span> unsafe_nat_diff(ordinal end<span class="symbol">,</span> ordinal start)
  to_list <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> slice_size)<span class="symbol">.</span>
    xs[unsafe_from_ordinal(n<span class="symbol">=</span>n<span class="symbol">,</span> ordinal i <span class="symbol">+</span> ordinal start)]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Dynamic buffer</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">DynBuffer</span>(a) <span class="symbol">=</span>
  size     <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Nat</span>
  max_size <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Nat</span>
  buffer   <span class="symbol">:</span> <span class="type-name">Ptr</span> (<span class="type-name">Ptr</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_dynamic_buffer(action<span class="symbol">:</span> (<span class="type-name">DynBuffer</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span><span class="symbol">,</span> b) <span class="symbol">=</span>
  initMaxSize <span class="symbol">=</span> 256
  sizePtr <span class="symbol">&lt;-</span> with_alloc 1
  store(sizePtr<span class="symbol">,</span> 0)
  maxSizePtr <span class="symbol">&lt;-</span> with_alloc 1
  store(maxSizePtr<span class="symbol">,</span> initMaxSize)
  bufferPtr <span class="symbol">&lt;-</span> with_alloc 1
  store(bufferPtr<span class="symbol">,</span> malloc initMaxSize)
  result <span class="symbol">=</span> action <span class="symbol">$</span> <span class="type-name">DynBuffer</span><span class="symbol">.</span>new(sizePtr<span class="symbol">,</span> maxSizePtr<span class="symbol">,</span> bufferPtr)
  free <span class="symbol">$</span> load bufferPtr
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maybe_increase_buffer_size(db<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a<span class="symbol">,</span> sizeDelta<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>) <span class="symbol">=</span>
  size     <span class="symbol">=</span> load db<span class="symbol">.</span>size
  max_size <span class="symbol">=</span> load db<span class="symbol">.</span>max_size
  bufPtr   <span class="symbol">=</span> load db<span class="symbol">.</span>buffer
  newSize <span class="symbol">=</span> sizeDelta <span class="symbol">+</span> size
  <span class="keyword">if</span> newSize <span class="symbol">&gt;</span> max_size <span class="keyword">then</span>
    <span class="comment">-- TODO: maybe this should use integer arithmetic?
</span>    newMaxSize <span class="symbol">=</span> f_to_n <span class="symbol">$</span> 2<span class="symbol">.</span>0 `pow` (ceil <span class="symbol">$</span> log2 <span class="symbol">$</span> n_to_f newSize)
    newBufPtr <span class="symbol">=</span> malloc newMaxSize
    memcpy(newBufPtr<span class="symbol">,</span> bufPtr<span class="symbol">,</span> size)
    free bufPtr
    store(db<span class="symbol">.</span>max_size<span class="symbol">,</span> newMaxSize)
    store(db<span class="symbol">.</span>buffer  <span class="symbol">,</span> newBufPtr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> add_at_nat_ptr(ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Nat</span><span class="symbol">,</span> n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="symbol">=</span>
  store(ptr<span class="symbol">,</span> load ptr <span class="symbol">+</span> n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> extend_dynamic_buffer(buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a<span class="symbol">,</span> new<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} ()  <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>) <span class="symbol">=</span>
  <span class="type-name">AsList</span>(n<span class="symbol">,</span> xs) <span class="symbol">=</span> new
  maybe_increase_buffer_size(buf<span class="symbol">,</span> n)
  bufPtr <span class="symbol">=</span> load buf<span class="symbol">.</span>buffer
  size   <span class="symbol">=</span> load buf<span class="symbol">.</span>size
  store_table(bufPtr <span class="symbol">+&gt;&gt;</span> size<span class="symbol">,</span> xs)
  add_at_nat_ptr(buf<span class="symbol">.</span>size<span class="symbol">,</span> n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> load_dynamic_buffer(buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">List</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>) <span class="symbol">=</span>
  bufPtr <span class="symbol">=</span> load buf<span class="symbol">.</span>buffer
  size   <span class="symbol">=</span> load buf<span class="symbol">.</span>size
  <span class="type-name">AsList</span>(size<span class="symbol">,</span> table_from_ptr bufPtr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> push_dynamic_buffer(buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Storable</span>) <span class="symbol">=</span>
  extend_dynamic_buffer(buf<span class="symbol">,</span> to_list [x])
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Strings and Characters</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">String</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">List</span> <span class="type-name">Char</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> string_from_char_ptr(n<span class="symbol">:</span><span class="type-name">Word32</span><span class="symbol">,</span> ptr<span class="symbol">:</span><span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  <span class="type-name">AsList</span>(rep_to_nat n<span class="symbol">,</span> table_from_ptr ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO. This is ASCII code point. It really should be Int32 for Unicode codepoint
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> codepoint(c<span class="symbol">:</span><span class="type-name">Char</span>) <span class="symbol">-&gt;</span> <span class="type-name">Int</span> <span class="symbol">=</span> w8_to_i c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">CString</span> <span class="symbol">=</span>
  ptr <span class="symbol">:</span>  <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: check the string contains no nulls
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_c_string(
    s<span class="symbol">:</span><span class="type-name">String</span><span class="symbol">,</span>
    action<span class="symbol">:</span> (<span class="type-name">CString</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a
    ) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="type-name">AsList</span>(n<span class="symbol">,</span> s&#39;) <span class="symbol">=</span> s <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">\</span><span class="type-name">NUL</span>&quot;
  with_table_ptr s&#39; <span class="symbol">\</span>ptr<span class="symbol">.</span> action <span class="symbol">$</span> <span class="type-name">CString</span><span class="symbol">.</span>new(ptr<span class="symbol">.</span>val)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Show interface</h3>
<p>For things that can be shown.
<code>show</code> gives a string representation of its input.
No particular promises are made to exactly what that representation will contain.
In particular it is <strong>not</strong> promised to be parseable.
Nor does it promise a particular level of precision for numeric values.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Show</span>(a)
  show <span class="symbol">:</span> (a) <span class="symbol">-&gt;</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(<span class="type-name">String</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showInt32&quot; showInt32 <span class="symbol">:</span> (<span class="type-name">Int32</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showInt32 x
    string_from_char_ptr(n<span class="symbol">,</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showInt64&quot; showInt64 <span class="symbol">:</span> (<span class="type-name">Int64</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(<span class="type-name">Int64</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showInt64 x
    string_from_char_ptr(n<span class="symbol">,</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span> show <span class="symbol">$</span> n_to_i64 x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showFloat32&quot; showFloat32 <span class="symbol">:</span> (<span class="type-name">Float32</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showFloat32 x
    string_from_char_ptr(n<span class="symbol">,</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;showFloat64&quot; showFloat64 <span class="symbol">:</span> (<span class="type-name">Float64</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Word32</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(<span class="type-name">Float64</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> showFloat64 x
    string_from_char_ptr(n<span class="symbol">,</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>(())
  <span class="keyword">def</span> show(_) <span class="symbol">=</span> &quot;()&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Show</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Show</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span>
    (a<span class="symbol">,</span> b) <span class="symbol">=</span> x
    &quot;(&quot; <span class="symbol">&lt;&gt;</span> show a <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show b <span class="symbol">&lt;&gt;</span> &quot;)&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>((a<span class="symbol">,</span> b<span class="symbol">,</span> c)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Show</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Show</span><span class="symbol">,</span> c<span class="symbol">|</span><span class="type-name">Show</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span>
    (a<span class="symbol">,</span> b<span class="symbol">,</span> c) <span class="symbol">=</span> x
    &quot;(&quot; <span class="symbol">&lt;&gt;</span> show a <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show b <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show c <span class="symbol">&lt;&gt;</span> &quot;)&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span>((a<span class="symbol">,</span> b<span class="symbol">,</span> c<span class="symbol">,</span> d)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Show</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Show</span><span class="symbol">,</span> c<span class="symbol">|</span><span class="type-name">Show</span><span class="symbol">,</span> d<span class="symbol">|</span><span class="type-name">Show</span>)
  <span class="keyword">def</span> show(x) <span class="symbol">=</span>
    (a<span class="symbol">,</span> b<span class="symbol">,</span> c<span class="symbol">,</span> d) <span class="symbol">=</span> x
    &quot;(&quot; <span class="symbol">&lt;&gt;</span> show a <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show b <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show c <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show d <span class="symbol">&lt;&gt;</span> &quot;)&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Parse interface</h3>
<p>For types that can be parsed from a <code>String</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Parse</span>(a)
  parseString <span class="symbol">:</span> (<span class="type-name">String</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;strtof&quot; strtofFFI <span class="symbol">:</span> (<span class="type-name">RawPtr</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Float</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Parse</span>(<span class="type-name">Float</span>)
  <span class="keyword">def</span> parseString(str) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span>
    <span class="type-name">AsList</span>(str_len<span class="symbol">,</span> _) <span class="symbol">=</span> str
    with_c_string str <span class="symbol">\</span>cStr<span class="symbol">.</span>
      with_alloc 1 <span class="symbol">\</span>end_ptr<span class="symbol">:</span>(<span class="type-name">Ptr</span> (<span class="type-name">Ptr</span> <span class="type-name">Char</span>))<span class="symbol">.</span>
        result <span class="symbol">=</span> strtofFFI(cStr<span class="symbol">.</span>ptr<span class="symbol">,</span> end_ptr<span class="symbol">.</span>val)
        str_end_ptr <span class="symbol">=</span> load end_ptr
        consumed <span class="symbol">=</span> raw_ptr_to_i64 str_end_ptr<span class="symbol">.</span>val <span class="symbol">-</span> raw_ptr_to_i64 cStr<span class="symbol">.</span>ptr
        <span class="keyword">if</span> consumed <span class="symbol">==</span> (n_to_i64 str_len) <span class="keyword">then</span> <span class="type-name">Just</span> result <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Floating-point helper functions</h2>
<p>TODO: Move these to be with Elementary/Special functions. Or move those to be here.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sign(x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> 1<span class="symbol">.</span>0
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="symbol">-</span>1<span class="symbol">.</span>0
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> copysign(a<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">,</span> b<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> b <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> a
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> b <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> (<span class="symbol">-</span>a)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block">infinity <span class="symbol">=</span> 1<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">nan      <span class="symbol">=</span> 0<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isinf(x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (x <span class="symbol">==</span> infinity) <span class="symbol">||</span> (x <span class="symbol">==</span> <span class="symbol">-</span>infinity)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isnan(x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not (x <span class="symbol">&gt;=</span> x <span class="symbol">&amp;&amp;</span> x <span class="symbol">&lt;=</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE-754R 5.11: Floating Point Comparison Relation cmpUnordered.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> either_is_nan(x<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (isnan x) <span class="symbol">||</span> (isnan y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>File system operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">FilePath</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_null_raw_ptr(ptr<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  raw_ptr_to_i64 ptr <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_nullable_raw_ptr(ptr<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> (<span class="type-name">Ptr</span> a) <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="keyword">if</span> is_null_raw_ptr ptr
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">Ptr</span><span class="symbol">.</span>new ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> c_string_ptr(s<span class="symbol">:</span><span class="type-name">CString</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> (<span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">=</span> from_nullable_raw_ptr s<span class="symbol">.</span>ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">StreamMode</span> <span class="symbol">=</span>
  <span class="type-name">ReadMode</span>
  <span class="type-name">WriteMode</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">Stream</span>(mode<span class="symbol">:</span><span class="type-name">StreamMode</span>) <span class="symbol">=</span>
  ptr <span class="symbol">:</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Stream IO</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fopen&quot;  fopenFFI  <span class="symbol">:</span> (<span class="type-name">RawPtr</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>)               <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fclose&quot; fcloseFFI <span class="symbol">:</span> (<span class="type-name">RawPtr</span>)                       <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fwrite&quot; fwriteFFI <span class="symbol">:</span> (<span class="type-name">RawPtr</span><span class="symbol">,</span> <span class="type-name">Int64</span><span class="symbol">,</span> <span class="type-name">Int64</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fread&quot;  freadFFI  <span class="symbol">:</span> (<span class="type-name">RawPtr</span><span class="symbol">,</span> <span class="type-name">Int64</span><span class="symbol">,</span> <span class="type-name">Int64</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;fflush&quot; fflushFFI <span class="symbol">:</span> (<span class="type-name">RawPtr</span>)                       <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fopen(path<span class="symbol">:</span><span class="type-name">String</span><span class="symbol">,</span> mode<span class="symbol">:</span><span class="type-name">StreamMode</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Stream</span> mode) <span class="symbol">=</span>
  modeStr <span class="symbol">=</span> <span class="keyword">case</span> mode <span class="keyword">of</span>
    <span class="type-name">ReadMode</span>  <span class="symbol">-&gt;</span> &quot;r&quot;
    <span class="type-name">WriteMode</span> <span class="symbol">-&gt;</span> &quot;w&quot;
  with_c_string path <span class="symbol">\</span>cPath<span class="symbol">.</span>
    with_c_string modeStr <span class="symbol">\</span>cMode<span class="symbol">.</span>
      <span class="type-name">Stream</span><span class="symbol">.</span>new <span class="symbol">$</span> fopenFFI(cPath<span class="symbol">.</span>ptr<span class="symbol">,</span> cMode<span class="symbol">.</span>ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fclose(stream<span class="symbol">:</span><span class="type-name">Stream</span> mode) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="keyword">given</span> (mode) <span class="symbol">=</span>
  fcloseFFI stream<span class="symbol">.</span>ptr
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fwrite(stream<span class="symbol">:</span><span class="type-name">Stream</span> <span class="type-name">WriteMode</span><span class="symbol">,</span> s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="symbol">=</span>
  <span class="type-name">AsList</span>(n<span class="symbol">,</span> s&#39;) <span class="symbol">=</span> s
  with_table_ptr s&#39; <span class="symbol">\</span>ptr<span class="symbol">.</span>
    fwriteFFI(ptr<span class="symbol">.</span>val<span class="symbol">,</span> i_to_i64 1<span class="symbol">,</span> n_to_i64 n<span class="symbol">,</span> stream<span class="symbol">.</span>ptr)
  fflushFFI stream<span class="symbol">.</span>ptr
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Iteration</h3>
<p>TODO: move this out of the file-system section</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> while(body<span class="symbol">:</span> () <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} () <span class="keyword">given</span> (eff) <span class="symbol">=</span>
  body&#39; <span class="symbol">:</span> () <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Word8</span> <span class="symbol">=</span> <span class="symbol">\.</span> b_to_w8 <span class="symbol">$</span> body()
  %while(body&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">IterResult</span>(a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  <span class="type-name">Continue</span>
  <span class="type-name">Done</span>(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: can we improve effect inference so we don&#39;t need this?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lift_state(ref<span class="symbol">:</span> <span class="type-name">Ref</span>(h<span class="symbol">,</span> c)<span class="symbol">,</span> f<span class="symbol">:</span>(a) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} b<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h<span class="symbol">|</span>eff} b
      <span class="keyword">given</span> (a<span class="symbol">,</span> b<span class="symbol">,</span> c<span class="symbol">,</span> h<span class="symbol">,</span> eff) <span class="symbol">=</span>
  f x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- A little iteration combinator
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iter(body<span class="symbol">:</span> (<span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">IterResult</span> a) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) <span class="symbol">=</span>
  result <span class="symbol">=</span> yield_state <span class="type-name">Nothing</span> <span class="symbol">\</span>resultRef<span class="symbol">.</span>
    i <span class="symbol">&lt;-</span> with_state 0
    while <span class="symbol">\.</span>
      continue <span class="symbol">=</span> is_nothing <span class="symbol">$</span> get resultRef
      <span class="keyword">if</span> continue <span class="keyword">then</span>
        <span class="keyword">case</span> lift_state(resultRef<span class="symbol">,</span> (<span class="symbol">\</span>x<span class="symbol">.</span> lift_state(i<span class="symbol">,</span> body<span class="symbol">,</span> x))<span class="symbol">,</span> get i) <span class="keyword">of</span>
          <span class="type-name">Continue</span> <span class="symbol">-&gt;</span> i <span class="symbol">:=</span> get i <span class="symbol">+</span> 1
          <span class="type-name">Done</span>(result) <span class="symbol">-&gt;</span> resultRef <span class="symbol">:=</span> <span class="type-name">Just</span> result
      continue
  <span class="keyword">case</span> result <span class="keyword">of</span>
    <span class="type-name">Just</span>(ans) <span class="symbol">-&gt;</span> ans
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> unreachable()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> bounded_iter(
    maxIters<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span>
    fallback<span class="command">:a</span><span class="symbol">,</span>
    body<span class="symbol">:</span>(<span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">IterResult</span> a
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> eff) <span class="symbol">=</span> iter <span class="symbol">\</span>i<span class="symbol">.</span>
  <span class="keyword">if</span> i <span class="symbol">&gt;=</span> maxIters
    <span class="keyword">then</span> <span class="type-name">Done</span> fallback
    <span class="keyword">else</span> body i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Environment Variables</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_c_string(s<span class="symbol">:</span><span class="type-name">CString</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} (<span class="type-name">Maybe</span> <span class="type-name">String</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> c_string_ptr s <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span>(ptr) <span class="symbol">-&gt;</span>
      <span class="type-name">Just</span> <span class="keyword">do</span>
        buf <span class="symbol">&lt;-</span> with_dynamic_buffer
        i <span class="symbol">&lt;-</span> iter
        c <span class="symbol">=</span> load <span class="symbol">$</span> ptr <span class="symbol">+&gt;&gt;</span> i
        <span class="keyword">if</span> c <span class="symbol">==</span> &#39;<span class="symbol">\</span><span class="type-name">NUL</span>&#39;
          <span class="keyword">then</span> <span class="type-name">Done</span> <span class="symbol">$</span> load_dynamic_buffer buf
          <span class="keyword">else</span>
            push_dynamic_buffer(buf<span class="symbol">,</span> c)
            <span class="type-name">Continue</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;getenv&quot; getenvFFI <span class="symbol">:</span> (<span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get_env(name<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Maybe</span> <span class="type-name">String</span> <span class="symbol">=</span>
  cStr <span class="symbol">&lt;-</span> with_c_string name
  getenvFFI cStr<span class="symbol">.</span>ptr <span class="symbol">|</span> <span class="type-name">CString</span><span class="symbol">.</span>new <span class="symbol">|</span> from_c_string
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> check_env(name<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Bool</span> <span class="symbol">=</span>
  is_just <span class="symbol">$</span> get_env name
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>More Stream IO</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fread(stream<span class="symbol">:</span><span class="type-name">Stream</span> <span class="type-name">ReadMode</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  <span class="comment">-- TODO: allow reading longer files!
</span>  n <span class="symbol">=</span> 4096
  ptr<span class="symbol">:</span>(<span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">&lt;-</span> with_alloc n
  buf <span class="symbol">&lt;-</span> with_dynamic_buffer
  iter <span class="symbol">\</span>_<span class="symbol">.</span>
    numRead <span class="symbol">=</span> i_to_w32 <span class="symbol">$</span> i64_to_i <span class="symbol">$</span> freadFFI(ptr<span class="symbol">.</span>val<span class="symbol">,</span> 1<span class="symbol">,</span> n_to_i64 n<span class="symbol">,</span> stream<span class="symbol">.</span>ptr)
    extend_dynamic_buffer(buf<span class="symbol">,</span> string_from_char_ptr(numRead<span class="symbol">,</span> ptr))
    <span class="keyword">if</span> numRead <span class="symbol">==</span> n_to_w32 n
      <span class="keyword">then</span> <span class="type-name">Continue</span>
      <span class="keyword">else</span> <span class="type-name">Done</span> ()
  load_dynamic_buffer buf
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Print</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get_output_stream() <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Stream</span> <span class="type-name">WriteMode</span> <span class="symbol">=</span>
  <span class="type-name">Stream</span><span class="symbol">.</span>new <span class="symbol">$</span> %outputStream()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> print(s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="symbol">=</span>
  stream <span class="symbol">=</span> get_output_stream()
  fwrite(stream<span class="symbol">,</span> s)
  fwrite(stream<span class="symbol">,</span> &quot;<span class="symbol">\</span>n&quot;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Shelling Out</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;popen&quot;   popenFFI   <span class="symbol">:</span> (<span class="type-name">RawPtr</span><span class="symbol">,</span> <span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;remove&quot;  removeFFI  <span class="symbol">:</span> (<span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;mkstemp&quot; mkstempFFI <span class="symbol">:</span> (<span class="type-name">RawPtr</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">foreign</span> &quot;close&quot;   closeFFI   <span class="symbol">:</span> (<span class="type-name">Int32</span>)  <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> shell_out(command<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  modeStr <span class="symbol">=</span> &quot;r&quot;
  with_c_string command <span class="symbol">\</span>command&#39;<span class="symbol">.</span>
    with_c_string modeStr <span class="symbol">\</span>modeStr&#39;<span class="symbol">.</span>
      pipe <span class="symbol">=</span> <span class="type-name">Stream</span><span class="symbol">.</span>new <span class="symbol">$</span> popenFFI(command&#39;<span class="symbol">.</span>ptr<span class="symbol">,</span> modeStr&#39;<span class="symbol">.</span>ptr)
      fread pipe
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Partial functions</h2>
<p>A partial function in this context is a function that can error.
i.e. a function that is not actually defined for all of its supposed domain.
Not to be confused with a partially applied function</p>
</div></div><div class="cell"><div class="prose-block"><h3>Error throwing</h3>
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> error(s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span>
  print s
  %throwError(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> todo() <span class="symbol">-&gt;&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span> error &quot;<span class="type-name">TODO</span><span class="symbol">:</span> implement it<span class="symbol">!</span>&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>File Operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> delete_file(f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="symbol">=</span>
  s <span class="symbol">&lt;-</span> with_c_string(f)
  removeFFI s<span class="symbol">.</span>ptr
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_file(
    f<span class="symbol">:</span><span class="type-name">FilePath</span><span class="symbol">,</span>
    mode<span class="symbol">:</span><span class="type-name">StreamMode</span><span class="symbol">,</span>
    action<span class="symbol">:</span>(<span class="type-name">Stream</span> mode) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a
    ) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a  <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  stream <span class="symbol">=</span> fopen(f<span class="symbol">,</span> mode)
  <span class="keyword">if</span> is_null_raw_ptr stream<span class="symbol">.</span>ptr
    <span class="keyword">then</span>
      error <span class="symbol">$</span> &quot;<span class="type-name">Unable</span> to open file<span class="symbol">:</span> &quot; <span class="symbol">&lt;&gt;</span> f
    <span class="keyword">else</span>
      result <span class="symbol">=</span> action stream
      fclose stream
      result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> write_file(f<span class="symbol">:</span><span class="type-name">FilePath</span><span class="symbol">,</span> s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} () <span class="symbol">=</span>
  with_file(f<span class="symbol">,</span> <span class="type-name">WriteMode</span>) <span class="symbol">\</span>stream<span class="symbol">.</span> fwrite(stream<span class="symbol">,</span> s)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> read_file(f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  with_file(f<span class="symbol">,</span> <span class="type-name">ReadMode</span>) <span class="symbol">\</span>stream<span class="symbol">.</span> fread stream
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> has_file(f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Bool</span> <span class="symbol">=</span>
  stream <span class="symbol">=</span> fopen(f<span class="symbol">,</span> <span class="type-name">ReadMode</span>)
  result <span class="symbol">=</span> not (is_null_raw_ptr stream<span class="symbol">.</span>ptr)
  <span class="keyword">if</span> result <span class="keyword">then</span> fclose stream
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Temporary Files</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> new_temp_file() <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">FilePath</span> <span class="symbol">=</span>
  s <span class="symbol">&lt;-</span> with_c_string &quot;<span class="symbol">/</span>tmp<span class="symbol">/</span>dex<span class="symbol">-</span><span class="type-name">XXXXXX</span>&quot;
  fd <span class="symbol">=</span> mkstempFFI s<span class="symbol">.</span>ptr
  closeFFI fd
  string_from_char_ptr(15<span class="symbol">,</span> (<span class="type-name">Ptr</span><span class="symbol">.</span>new s<span class="symbol">.</span>ptr))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_temp_file(action<span class="symbol">:</span> (<span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a <span class="keyword">given</span> (a) <span class="symbol">=</span>
  tmpFile <span class="symbol">=</span> new_temp_file()
  result <span class="symbol">=</span> action tmpFile
  delete_file tmpFile
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_temp_files(action<span class="symbol">:</span> (n<span class="symbol">=&gt;</span><span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  tmpFiles <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> new_temp_file()
  result <span class="symbol">=</span> action tmpFiles
  <span class="keyword">for</span> i<span class="symbol">.</span> delete_file tmpFiles[i]
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Table operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> from_ordinal_error(i<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> upper<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">String</span> <span class="symbol">=</span>
  &quot;<span class="type-name">Ordinal</span> index out <span class="keyword">of</span> range<span class="symbol">:</span>&quot; <span class="symbol">&lt;&gt;</span> show i <span class="symbol">&lt;&gt;</span> &quot; <span class="symbol">&gt;=</span> &quot; <span class="symbol">&lt;&gt;</span> show upper
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_ordinal(i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> i <span class="symbol">&lt;</span> size n <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafe_from_ordinal i
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> error <span class="symbol">$</span> from_ordinal_error(i<span class="symbol">,</span> size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: should this be called `from_ordinal`?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> to_ix(i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> n  <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> i <span class="symbol">&lt;</span> size n <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> unsafe_from_ordinal i
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: could make an `unsafeCastIndex` and this could avoid the runtime copy
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: safe (runtime-checked) and unsafe versions
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cast_table(xs<span class="command">:to</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> from<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (from<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> to<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> size from <span class="symbol">==</span> size to <span class="keyword">of</span>
     <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafe_cast_table xs
     <span class="type-name">False</span> <span class="symbol">-&gt;</span> error <span class="symbol">$</span>
       &quot;<span class="type-name">Table</span> size mismatch in cast<span class="symbol">:</span> &quot; <span class="symbol">&lt;&gt;</span> show (size from) <span class="symbol">&lt;&gt;</span> &quot; vs &quot; <span class="symbol">&lt;&gt;</span> show (size to)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> asidx(i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> from_ordinal i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">@</span>)(i<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">-&gt;</span> n <span class="symbol">=</span> from_ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> slice(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> start<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">-&gt;</span> m<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs[from_ordinal (ordinal i <span class="symbol">+</span> start)]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> head(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span> xs[0<span class="symbol">@</span>_]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tail(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> start<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">List</span> a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  numElts <span class="symbol">=</span> size n <span class="symbol">-|</span> start
  to_list <span class="symbol">$</span> slice(xs<span class="symbol">,</span> start<span class="symbol">,</span> <span class="type-name">Fin</span> numElts)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Pseudorandom number generator utilities</h2>
<p>Dex does not use a stateful random number generator.
Rather it uses what is known as a split-able random number generator, which is based on a hash function.
Dex's PRNG system is modelled directly after <a href="https://github.com/google/jax/blob/master/design_notes/prng.md">JAX's</a>, which is based on a well established but shockingly underused idea from the functional programming community: the splittable PRNG. It's a good idea for many reasons, but it's especially helpful in a parallel setting. If you want to read more, <a href="http://publications.lib.chalmers.se/records/fulltext/183348/local_183348.pdf">Splittable pseudorandom number generators using cryptographic hashing</a> describes the splitting model itself and <a href="http://www.thesalmons.org/john/random123/papers/random123sc11.pdf">D.E. Shaw Research's counter-based PRNG</a> proposes the particular hash function we use.</p>
</div></div><div class="cell"><div class="prose-block"><h3>Key functions</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: newtype
</span></div></div><div class="cell"><div class="code-block"><span class="type-name">Key</span> <span class="symbol">=</span> <span class="type-name">Word64</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> threefry_2x32(k<span class="symbol">:</span><span class="type-name">Word64</span><span class="symbol">,</span> count<span class="symbol">:</span><span class="type-name">Word64</span>) <span class="symbol">-&gt;</span> <span class="type-name">Word64</span> <span class="symbol">=</span>
  <span class="comment">-- Based on jax&#39;s threefry_2x32 by Matt Johnson and Peter Hawkins
</span>  rotations1 <span class="symbol">=</span> [13<span class="symbol">,</span> 15<span class="symbol">,</span> 26<span class="symbol">,</span> 6]
  rotations2 <span class="symbol">=</span> [17<span class="symbol">,</span> 29<span class="symbol">,</span> 16<span class="symbol">,</span> 24]

  k0 <span class="symbol">=</span> low_word k
  k1 <span class="symbol">=</span> high_word k
  <span class="comment">-- TODO: add a fromHex
</span>  k2 <span class="symbol">=</span> k0 <span class="symbol">.^.</span> k1 <span class="symbol">.^.</span> (n_to_w32 466688986) <span class="comment">-- 0x1BD11BDA
</span>
  x <span class="symbol">=</span> low_word count
  y <span class="symbol">=</span> high_word count
  x <span class="symbol">=</span> x <span class="symbol">+</span> k0
  y <span class="symbol">=</span> y <span class="symbol">+</span> k1

  rotations <span class="symbol">=</span> [rotations1<span class="symbol">,</span> rotations2]
  ks <span class="symbol">=</span> [k1<span class="symbol">,</span> k2<span class="symbol">,</span> k0]
  (x<span class="symbol">,</span> y) <span class="symbol">=</span> yield_state (x<span class="symbol">,</span> y) <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> 5)<span class="symbol">.</span>
    <span class="keyword">for</span> j<span class="symbol">.</span>
      (x<span class="symbol">,</span> y) <span class="symbol">=</span> get ref
      rotationIndex <span class="symbol">=</span> unsafe_from_ordinal (ordinal i `mod` 2)
      rot <span class="symbol">=</span> rotations[rotationIndex<span class="symbol">,</span> j]
      x <span class="symbol">=</span> x <span class="symbol">+</span> y
      y <span class="symbol">=</span> (y <span class="symbol">.&lt;&lt;.</span> rot) <span class="symbol">.|.</span> (y <span class="symbol">.&gt;&gt;.</span> (32 <span class="symbol">-</span> rot))
      y <span class="symbol">=</span> x <span class="symbol">.^.</span> y
      ref <span class="symbol">:=</span> (x<span class="symbol">,</span> y)
    (x<span class="symbol">,</span> y) <span class="symbol">=</span> get ref
    x <span class="symbol">=</span> x <span class="symbol">+</span> ks[unsafe_from_ordinal (ordinal i `mod` 3)]
    y <span class="symbol">=</span> y <span class="symbol">+</span> ks[unsafe_from_ordinal (((ordinal i)<span class="symbol">+</span>1) `mod` 3)] <span class="symbol">+</span> n_to_w32 ((ordinal i)<span class="symbol">+</span>1)
    ref <span class="symbol">:=</span> (x<span class="symbol">,</span> y)

  (w32_to_w64 x <span class="symbol">.&lt;&lt;.</span> 32) <span class="symbol">.|.</span> (w32_to_w64 y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> hash(x<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Key</span> <span class="symbol">=</span>
  y64 <span class="symbol">=</span> n_to_w64 y
  threefry_2x32(x<span class="symbol">,</span> y64)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> new_key(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash(0<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> many(f<span class="symbol">:</span>(<span class="type-name">Key</span>)<span class="symbol">-&gt;</span>a<span class="symbol">,</span> k<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">,</span> i<span class="command">:n</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> f hash(k<span class="symbol">,</span> ordinal i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey(k<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">,</span> i<span class="command">:n</span>) <span class="symbol">-&gt;</span> <span class="type-name">Key</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> hash(k<span class="symbol">,</span> ordinal i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> split_key(k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">-&gt;</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Key</span> <span class="keyword">given</span> (n<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> ixkey(k<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Sample Generators</h3>
<p>These functions generate samples taken from, different distributions.
Such as <code>rand_mat</code> with samples from the distribution of floating point matrices where each element is taken from a i.i.d. uniform distribution. Note that additional standard distributions are provided by the <code>stats</code> library.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand(k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  exponent_bits <span class="symbol">=</span> 1065353216 <span class="comment">-- 1065353216 = 127 &lt;&lt; 23
</span>  mantissa_bits <span class="symbol">=</span> (high_word k <span class="symbol">.&amp;.</span> 8388607)  <span class="comment">-- 8388607 == (1 &lt;&lt; 23) - 1
</span>  bits <span class="symbol">=</span> exponent_bits <span class="symbol">.|.</span> mantissa_bits
  %bitcast(<span class="type-name">Float</span><span class="symbol">,</span> bits) <span class="symbol">-</span> 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_vec(n<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> f<span class="symbol">:</span> (<span class="type-name">Key</span>) <span class="symbol">-&gt;</span> a<span class="symbol">,</span> k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">-&gt;</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a  <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span> f ixkey(k<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_mat(n<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> m<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> f<span class="symbol">:</span> (<span class="type-name">Key</span>) <span class="symbol">-&gt;</span> a<span class="symbol">,</span> k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">-&gt;</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Fin</span> m <span class="symbol">=&gt;</span> a <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> f ixkey(k<span class="symbol">,</span> (i<span class="symbol">,</span> j))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn(k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> split_key k
  <span class="comment">-- rand is uniform between 0 and 1, but implemented such that it rounds to 0
</span>  <span class="comment">-- (in float32) once every few million draws, but never rounds to 1.
</span>  u1 <span class="symbol">=</span> 1<span class="symbol">.</span>0 <span class="symbol">-</span> (rand k1)
  u2 <span class="symbol">=</span> rand k2
  sqrt ((<span class="symbol">-</span>2<span class="symbol">.</span>0) <span class="symbol">*</span> log u1) <span class="symbol">*</span> cos (2<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">*</span> u2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Make this better...
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_int(k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> w64_to_n k `mod` 2147483647
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn_vec(k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> randn (ixkey(k<span class="symbol">,</span> i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand_idx(k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  rand k <span class="symbol">*</span> n_to_f (size n) <span class="symbol">|</span> floor <span class="symbol">|</span> f_to_n <span class="symbol">|</span> unsafe_from_ordinal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Inner product typeclass</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">InnerProd</span>(v<span class="symbol">|</span><span class="type-name">VSpace</span>)
  inner_prod <span class="symbol">:</span> (v<span class="symbol">,</span> v) <span class="symbol">-&gt;</span> <span class="type-name">Float</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">InnerProd</span>(<span class="type-name">Float</span>)
  <span class="keyword">def</span> inner_prod(x<span class="symbol">,</span> y) <span class="symbol">=</span> x <span class="symbol">*</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">InnerProd</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">InnerProd</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="keyword">def</span> inner_prod(x<span class="symbol">,</span> y) <span class="symbol">=</span>sum <span class="keyword">for</span> i<span class="symbol">.</span> inner_prod(x[i]<span class="symbol">,</span> y[i])
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Arbitrary</h2>
<p>Type class for generating example values</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Arbitrary</span>(a)
  arb <span class="symbol">:</span> (<span class="type-name">Key</span>) <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>(<span class="type-name">Bool</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> key <span class="symbol">.&amp;.</span> 1 <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>(<span class="type-name">Float32</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> randn key
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>(<span class="type-name">Int32</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> f_to_i <span class="symbol">$</span> randn key <span class="symbol">*</span> 5<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>(<span class="type-name">Nat</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> f_to_n <span class="symbol">$</span> randn key <span class="symbol">*</span> 5<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>(n<span class="symbol">=&gt;</span>a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Arbitrary</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey(key<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(<span class="symbol">..&lt;</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Arbitrary</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey(key<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Arbitrary</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey(key<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Arbitrary</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey(key<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>((i<span class="command">:n</span>)<span class="symbol">=&gt;</span>(i<span class="symbol">&lt;..</span>) <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Arbitrary</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey(key<span class="symbol">,</span> i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>((a<span class="symbol">,</span> b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Arbitrary</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Arbitrary</span>)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span>
    [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> split_key key
    (arb k1<span class="symbol">,</span> arb k2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span>(<span class="type-name">Fin</span> n) <span class="keyword">given</span> (n)
  <span class="keyword">def</span> arb(key) <span class="symbol">=</span> rand_idx key
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Ord on Arrays</h2>
</div></div><div class="cell"><div class="prose-block"><h3>Searching</h3>
</div></div><div class="cell"><div class="prose-block"><p>returns the highest index <code>i</code> such that <code>xs.i &lt;= x</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> search_sorted(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span>
  <span class="keyword">if</span> size n <span class="symbol">==</span> 0
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="keyword">if</span> x <span class="symbol">&lt;</span> xs[from_ordinal 0]
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span>
        low  <span class="symbol">&lt;-</span> with_state(0)
        high <span class="symbol">&lt;-</span> with_state(size n)
        _ <span class="symbol">&lt;-</span> iter
        numLeft <span class="symbol">=</span> n_to_i (get high) <span class="symbol">-</span> n_to_i (get low)
        <span class="keyword">if</span> numLeft <span class="symbol">==</span> 1
          <span class="keyword">then</span> <span class="type-name">Done</span> <span class="symbol">$</span> <span class="type-name">Just</span> <span class="symbol">$</span> from_ordinal <span class="symbol">$</span> get low
          <span class="keyword">else</span>
            centerIx <span class="symbol">=</span> get low <span class="symbol">+</span> unsafe_i_to_n (numLeft `idiv` 2)
            <span class="keyword">if</span> x <span class="symbol">&lt;</span> xs[from_ordinal centerIx]
              <span class="keyword">then</span> high <span class="symbol">:=</span> centerIx
              <span class="keyword">else</span> low  <span class="symbol">:=</span> centerIx
            <span class="type-name">Continue</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>min / max etc</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min_by(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>o<span class="symbol">,</span> x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (o<span class="symbol">|</span><span class="type-name">Ord</span><span class="symbol">,</span> a) <span class="symbol">=</span> select(f x <span class="symbol">&lt;</span> f y<span class="symbol">,</span> x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max_by(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>o<span class="symbol">,</span> x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (o<span class="symbol">|</span><span class="type-name">Ord</span><span class="symbol">,</span> a) <span class="symbol">=</span> select(f x <span class="symbol">&gt;</span> f y<span class="symbol">,</span> x<span class="symbol">,</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min(x1<span class="symbol">:</span> o<span class="symbol">,</span> x2<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> o <span class="keyword">given</span> (o<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> min_by(id<span class="symbol">,</span> x1<span class="symbol">,</span> x2)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max(x1<span class="symbol">:</span> o<span class="symbol">,</span> x2<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> o <span class="keyword">given</span> (o<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> max_by(id<span class="symbol">,</span> x1<span class="symbol">,</span> x2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum_by(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>o<span class="symbol">,</span> xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> o<span class="symbol">|</span><span class="type-name">Ord</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  reduce(xs[0<span class="symbol">@</span>_]<span class="symbol">,</span> <span class="symbol">\</span>x y<span class="symbol">.</span> min_by(f<span class="symbol">,</span> x<span class="symbol">,</span> y)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum_by(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span>o<span class="symbol">,</span> xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> o<span class="symbol">|</span><span class="type-name">Ord</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  reduce(xs[0<span class="symbol">@</span>_]<span class="symbol">,</span> <span class="symbol">\</span>x y<span class="symbol">.</span> max_by(f<span class="symbol">,</span> x<span class="symbol">,</span> y)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum(xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">-&gt;</span> o <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> o<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> minimum_by(id<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum(xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">-&gt;</span> o <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> o<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> maximum_by(id<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>argmin/argmax</h3>
<p>-- TODO: put in same section as <code>searchsorted</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argscan(comp<span class="symbol">:</span>(o<span class="symbol">,</span>o)<span class="symbol">-&gt;</span><span class="type-name">Bool</span><span class="symbol">,</span> xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (o<span class="symbol">|</span><span class="type-name">Ord</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  zeroth <span class="symbol">=</span> (0<span class="symbol">@</span>_<span class="symbol">,</span> xs[0<span class="symbol">@</span>_])
  compare <span class="symbol">=</span> <span class="symbol">\</span>p1 p2<span class="symbol">.</span>
    (idx1<span class="symbol">,</span> x1) <span class="symbol">=</span> p1
    (idx2<span class="symbol">,</span> x2) <span class="symbol">=</span> p2
    select(comp(x1<span class="symbol">,</span> x2)<span class="symbol">,</span> (idx1<span class="symbol">,</span> x1)<span class="symbol">,</span> (idx2<span class="symbol">,</span> x2))
  zipped <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (i<span class="symbol">,</span> xs[i])
  fst <span class="symbol">$</span> reduce(zeroth<span class="symbol">,</span> compare<span class="symbol">,</span> zipped)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmin(xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> o<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> argscan((<span class="symbol">&lt;</span>)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmax(xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> o<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span> argscan((<span class="symbol">&gt;</span>)<span class="symbol">,</span> xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lexical_order(
    compareElements<span class="symbol">:</span>(n<span class="symbol">,</span>n)<span class="symbol">-&gt;</span><span class="type-name">Bool</span><span class="symbol">,</span>
    compareLengths<span class="symbol">:</span> (<span class="type-name">Nat</span><span class="symbol">,</span><span class="type-name">Nat</span>)<span class="symbol">-&gt;</span><span class="type-name">Bool</span><span class="symbol">,</span>
    xList<span class="symbol">:</span><span class="type-name">List</span> n<span class="symbol">,</span>
    yList<span class="symbol">:</span><span class="type-name">List</span> n
    ) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>  <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span>
  <span class="comment">-- Orders Lists according to the order of their elements,
</span>  <span class="comment">-- in the same way a dictionary does.
</span>  <span class="comment">-- For example, this lets us sort Strings.
</span>  <span class="symbol">--</span>
  <span class="comment">-- More precisely, it returns True iff compareElements xs.i ys.i is true
</span>  <span class="comment">-- at the first location they differ.
</span>  <span class="symbol">--</span>
  <span class="comment">-- This function operates serially and short-circuits
</span>  <span class="comment">-- at the first difference.  One could also write this
</span>  <span class="comment">-- function as a parallel reduction, but it would be
</span>  <span class="comment">-- wasteful in the case where there is an early difference,
</span>  <span class="comment">-- because we can&#39;t short circuit.
</span>  <span class="type-name">AsList</span>(nx<span class="symbol">,</span> xs) <span class="symbol">=</span> xList
  <span class="type-name">AsList</span>(ny<span class="symbol">,</span> ys) <span class="symbol">=</span> yList
  iter <span class="symbol">\</span>i<span class="symbol">.</span>
    <span class="keyword">case</span> i <span class="symbol">==</span> min(nx<span class="symbol">,</span> ny) <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Done</span> <span class="symbol">$</span> compareLengths(nx<span class="symbol">,</span> ny)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span>
        xi <span class="symbol">=</span> xs[unsafe_from_ordinal i]
        yi <span class="symbol">=</span> ys[unsafe_from_ordinal i]
        <span class="keyword">case</span> compareElements(xi<span class="symbol">,</span> yi) <span class="keyword">of</span>
          <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Done</span> <span class="type-name">True</span>
          <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> xi <span class="symbol">==</span> yi <span class="keyword">of</span>
            <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Continue</span>
            <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Done</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span>(<span class="type-name">List</span> n) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ord</span>)
  <span class="keyword">def</span> (<span class="symbol">&gt;</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> lexical_order((<span class="symbol">&gt;</span>)<span class="symbol">,</span> (<span class="symbol">&gt;</span>)<span class="symbol">,</span> xs<span class="symbol">,</span> ys)
  <span class="keyword">def</span> (<span class="symbol">&lt;</span>)(xs<span class="symbol">,</span> ys) <span class="symbol">=</span> lexical_order((<span class="symbol">&lt;</span>)<span class="symbol">,</span> (<span class="symbol">&lt;</span>)<span class="symbol">,</span> xs<span class="symbol">,</span> ys)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>clip</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> clip(bounds<span class="symbol">:</span>(a<span class="symbol">,</span>a)<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span>
  (low<span class="symbol">,</span>high) <span class="symbol">=</span> bounds
  min(high<span class="symbol">,</span> max(low<span class="symbol">,</span> x))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Trigonometric functions</h2>
<p>TODO: these should be with the other Elementary/Special Functions</p>
<h3>atan/atan2</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan_inner(x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- From &quot;Computing accurate Horner form approximations to
</span>  <span class="comment">-- special functions in finite precision arithmetic&quot;
</span>  <span class="comment">-- https://arxiv.org/abs/1508.03211
</span>  <span class="comment">-- Only accurate in the range [-1, 1]
</span>  s <span class="symbol">=</span> x <span class="symbol">*</span> x
  r <span class="symbol">=</span> 0<span class="symbol">.</span>0027856871
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0158660002
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>042472221
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0749753043
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>106448799
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>142070308
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>199934542
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>333331466
  r <span class="symbol">=</span> r <span class="symbol">*</span> s
  r <span class="symbol">*</span> x <span class="symbol">+</span> x
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min_and_max(x<span class="command">:a</span><span class="symbol">,</span> y<span class="command">:a</span>) <span class="symbol">-&gt;</span> (a<span class="symbol">,</span> a) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ord</span>) <span class="symbol">=</span>
  select(x <span class="symbol">&lt;</span> y<span class="symbol">,</span> (x<span class="symbol">,</span> y)<span class="symbol">,</span> (y<span class="symbol">,</span> x))  <span class="comment">-- get both with one comparison.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan2(y<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- Based off of the Tensorflow implementation at
</span>  <span class="comment">-- github.com/tensorflow/mlir-hlo/blob/master/lib/
</span>  <span class="comment">-- Dialect/mhlo/transforms/legalize_trigonometric_to_approximation.cc#L147
</span>  <span class="comment">-- With a fix to the nan propagation.
</span>  abs_x <span class="symbol">=</span> abs x
  abs_y <span class="symbol">=</span> abs y
  (min_abs_x_y<span class="symbol">,</span> max_abs_x_y) <span class="symbol">=</span> min_and_max(abs_x<span class="symbol">,</span> abs_y)
  a <span class="symbol">=</span> atan_inner (min_abs_x_y <span class="symbol">/</span> max_abs_x_y)
  a <span class="symbol">=</span> select(abs_x <span class="symbol">&lt;=</span> abs_y<span class="symbol">,</span> (pi <span class="symbol">/</span> 2<span class="symbol">.</span>0) <span class="symbol">-</span>a<span class="symbol">,</span> a)
  a <span class="symbol">=</span> select(x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0<span class="symbol">,</span> pi <span class="symbol">-</span> a<span class="symbol">,</span>  a)
  t <span class="symbol">=</span> select(x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0<span class="symbol">,</span> pi<span class="symbol">,</span>  0<span class="symbol">.</span>0)
  a <span class="symbol">=</span> select(y <span class="symbol">==</span> 0<span class="symbol">.</span>0<span class="symbol">,</span> t<span class="symbol">,</span> a)
  t <span class="symbol">=</span> select(x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0<span class="symbol">,</span> 3<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">/</span> 4<span class="symbol">.</span>0<span class="symbol">,</span> pi <span class="symbol">/</span> 4<span class="symbol">.</span>0)
  a <span class="symbol">=</span> select(isinf x <span class="symbol">&amp;&amp;</span> isinf y<span class="symbol">,</span> t<span class="symbol">,</span> a)  <span class="comment">-- Handle infinite inputs.
</span>  a <span class="symbol">=</span> copysign(a<span class="symbol">,</span> y)
  select(either_is_nan(x<span class="symbol">,</span> y)<span class="symbol">,</span> nan<span class="symbol">,</span> a)  <span class="comment">-- Propagate NaNs.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan(x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span> atan2(x<span class="symbol">,</span> 1<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Miscellaneous utilities</h2>
<p>TODO: all of these should be in some other section</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reflect(i<span class="command">:n</span>) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  unsafe_from_ordinal <span class="symbol">$</span> unsafe_nat_diff(size n<span class="symbol">,</span> ordinal i <span class="symbol">+</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reverse(x<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> x[reflect i]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> wrap_periodic(n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> i<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> n <span class="symbol">=</span>
  unsafe_from_ordinal(n<span class="symbol">=</span>n<span class="symbol">,</span> i `mod` size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pad_to(m<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> x<span class="command">:a</span><span class="symbol">,</span> xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> m<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="keyword">for</span> i<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> n&#39; <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs[i&#39;<span class="symbol">@</span>_]
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> idiv_ceil(x<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> y<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> x `idiv` y <span class="symbol">+</span> b_to_n (x `rem` y <span class="symbol">/=</span> 0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intdiv2(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> %shr(nat_to_rep x<span class="symbol">,</span> 1 <span class="symbol">::</span> <span class="type-name">NatRep</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intpow2(power<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span> rep_to_nat <span class="symbol">$</span> %shl(1 <span class="symbol">::</span> <span class="type-name">NatRep</span><span class="symbol">,</span> nat_to_rep power)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_odd(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rem(x<span class="symbol">,</span> 2) <span class="symbol">==</span> 1
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_even(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rem(x<span class="symbol">,</span> 2) <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> is_power_<span class="keyword">of</span>_2(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="comment">-- A fast trick based on bitwise AND.
</span>  <span class="comment">-- This works on integer types larger than 8 bits.
</span>  <span class="comment">-- Note: The bitwise and operator (.&amp;.)
</span>  <span class="comment">-- is only defined for Byte, which is why
</span>  <span class="comment">-- we use %and here. TODO: Make (.&amp;.) polymorphic.
</span>  x&#39; <span class="symbol">=</span> nat_to_rep x
  <span class="keyword">if</span> x&#39; <span class="symbol">==</span> 0
    <span class="keyword">then</span> <span class="type-name">False</span>
    <span class="keyword">else</span> 0 <span class="symbol">==</span> %and(x&#39;<span class="symbol">,</span> (%isub(x&#39;<span class="symbol">,</span> 1<span class="symbol">::</span><span class="type-name">NatRep</span>)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- This computes the integer part of the binary logarithm of the input.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: natlog2 0 should do something other than underflow the answer.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Use LLVM ctlz intrinsic instead.  It needs a slightly new
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- code path in ImpToLLVM, because it&#39;s the first LLVM intrinsic
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- we have with a fixed-point argument.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- https://llvm.org/docs/LangRef.html#llvm-ctlz-intrinsic
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> natlog2(x<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="symbol">=</span>
  tmp <span class="symbol">=</span> yield_state 0 <span class="symbol">\</span>ans<span class="symbol">.</span>
    cmp <span class="symbol">&lt;-</span> run_state 1
    while <span class="symbol">\.</span>
      <span class="keyword">if</span> x <span class="symbol">&gt;=</span> (get cmp)
        <span class="keyword">then</span>
          ans <span class="symbol">:=</span> (get ans) <span class="symbol">+</span> 1
          cmp <span class="symbol">:=</span> rep_to_nat <span class="symbol">$</span> %shl(nat_to_rep <span class="symbol">$</span> get cmp<span class="symbol">,</span> 1 <span class="symbol">::</span> <span class="type-name">NatRep</span>)
          <span class="type-name">True</span>
        <span class="keyword">else</span>
          <span class="type-name">False</span>
  unsafe_nat_diff(tmp<span class="symbol">,</span> 1)  <span class="comment">-- TODO: something less horrible
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> general_integer_power(
    times<span class="symbol">:</span>(a<span class="symbol">,</span>a)<span class="symbol">-&gt;</span>a<span class="symbol">,</span>
    one<span class="command">:a</span><span class="symbol">,</span> base<span class="command">:a</span><span class="symbol">,</span>
    power<span class="symbol">:</span><span class="type-name">Nat</span>
    ) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  iters <span class="symbol">=</span> <span class="keyword">if</span> power <span class="symbol">==</span> 0 <span class="keyword">then</span> 0 <span class="keyword">else</span> 1 <span class="symbol">+</span> natlog2 power
  <span class="comment">-- Implements exponentiation by squaring.
</span>  <span class="comment">-- This could be nicer if there were a way to explicitly
</span>  <span class="comment">-- specify which typelcass instance to use for Mul.
</span>  yield_state one <span class="symbol">\</span>ans<span class="symbol">.</span>
    pow <span class="symbol">&lt;-</span> with_state power
    z <span class="symbol">&lt;-</span> with_state base
    <span class="keyword">for</span> _<span class="symbol">:</span>(<span class="type-name">Fin</span> iters)<span class="symbol">.</span>
      <span class="keyword">if</span> is_odd (get pow)
        <span class="keyword">then</span> ans <span class="symbol">:=</span> times(get ans<span class="symbol">,</span> get z)
      z <span class="symbol">:=</span> times(get z<span class="symbol">,</span> get z)
      pow <span class="symbol">:=</span> intdiv2 (get pow)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intpow(base<span class="command">:a</span><span class="symbol">,</span> power<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Mul</span>) <span class="symbol">=</span>
  general_integer_power((<span class="symbol">*</span>)<span class="symbol">,</span> one<span class="symbol">,</span> base<span class="symbol">,</span> power)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> from_just(x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">-&gt;</span> a <span class="keyword">given</span> (a) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span> <span class="type-name">Just</span>(x&#39;) <span class="symbol">-&gt;</span> x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any_sat(f<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span><span class="type-name">Bool</span><span class="symbol">,</span> xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="keyword">given</span> (a<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> any(each xs f)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> seq_maybes(xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Maybe</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> (n <span class="symbol">=&gt;</span> a) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span>
  <span class="comment">-- is it possible to implement this safely? (i.e. without using partial
</span>  <span class="comment">-- functions)
</span>  <span class="keyword">case</span> any_sat(is_nothing<span class="symbol">,</span> xs) <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> each xs from_just
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linear_search(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> query<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Eq</span>) <span class="symbol">=</span>
  yield_state <span class="type-name">Nothing</span> <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    <span class="keyword">case</span> xs[i] <span class="symbol">==</span> query <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> ref <span class="symbol">:=</span> <span class="type-name">Just</span> i
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> list_length(l<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="keyword">given</span> (a) <span class="symbol">=</span>
  <span class="type-name">AsList</span>(n<span class="symbol">,</span> _) <span class="symbol">=</span> l
  n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- This is for efficiency (rather than using `&lt;&gt;` repeatedly)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want this for any monoid but this implementation won&#39;t work.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> concat(lists<span class="command">:n</span><span class="symbol">=&gt;</span>(<span class="type-name">List</span> a)) <span class="symbol">-&gt;</span> <span class="type-name">List</span> a <span class="keyword">given</span> (a<span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  totalSize <span class="symbol">=</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> list_length lists[i]
  to_list <span class="symbol">$</span> with_state 0 <span class="symbol">\</span>listIdx<span class="symbol">.</span>
    eltIdx <span class="symbol">&lt;-</span> with_state 0
    <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> totalSize)<span class="symbol">.</span>
      while <span class="symbol">\.</span>
        continue <span class="symbol">=</span> get eltIdx <span class="symbol">&gt;=</span> list_length (lists[(get listIdx)<span class="symbol">@</span>_])
        <span class="keyword">if</span> continue
          <span class="keyword">then</span>
            eltIdx <span class="symbol">:=</span> 0
            listIdx <span class="symbol">:=</span> get listIdx <span class="symbol">+</span> 1
          <span class="keyword">else</span> ()
        continue
      <span class="type-name">AsList</span>(_<span class="symbol">,</span> xs) <span class="symbol">=</span> lists[(get listIdx)<span class="symbol">@</span>_]
      eltIdxVal <span class="symbol">=</span> get eltIdx
      eltIdx <span class="symbol">:=</span> eltIdxVal <span class="symbol">+</span> 1
      xs[eltIdxVal<span class="symbol">@</span>_]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cat_maybes(xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Maybe</span> a) <span class="symbol">-&gt;</span> <span class="type-name">List</span> a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  (num_res<span class="symbol">,</span> res_inds) <span class="symbol">=</span> yield_state (0<span class="symbol">::</span><span class="type-name">Nat</span><span class="symbol">,</span> <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> <span class="type-name">Nothing</span>) <span class="symbol">\</span>ref<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">case</span> xs[i] <span class="keyword">of</span>
      <span class="type-name">Just</span>(_) <span class="symbol">-&gt;</span>
        ix <span class="symbol">=</span> get <span class="symbol">$</span> fst_ref ref
        (snd_ref ref) <span class="symbol">!</span> (unsafe_from_ordinal ix) <span class="symbol">:=</span> <span class="type-name">Just</span> i
        fst_ref ref <span class="symbol">:=</span> ix <span class="symbol">+</span> 1
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> ()
  to_list <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> num_res)<span class="symbol">.</span>
    <span class="keyword">case</span> res_inds[unsafe_from_ordinal <span class="symbol">$</span> ordinal i] <span class="keyword">of</span>
      <span class="type-name">Just</span>(j) <span class="symbol">-&gt;</span> <span class="keyword">case</span> xs[j] <span class="keyword">of</span>
        <span class="type-name">Just</span>(x) <span class="symbol">-&gt;</span> x
        <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> todo <span class="comment">-- Impossible
</span>      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> todo <span class="comment">-- Impossible
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> filter(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> condition<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">List</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  cat_maybes <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">if</span> condition xs[i] <span class="keyword">then</span> <span class="type-name">Just</span> xs[i] <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> arg_filter(xs<span class="command">:n</span><span class="symbol">=&gt;</span>a<span class="symbol">,</span> condition<span class="symbol">:</span>(a)<span class="symbol">-&gt;</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> <span class="type-name">List</span> n <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  cat_maybes <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">if</span> condition xs[i] <span class="keyword">then</span> <span class="type-name">Just</span> i <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: use `ix_offset : [Ix n] -&gt; n -&gt; Int -&gt; Maybe n` instead
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prev_ix(i<span class="command">:n</span>) <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> i_to_n (n_to_i (ordinal i) <span class="symbol">-</span> 1) <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span>(i_prev) <span class="symbol">-&gt;</span> unsafe_from_ordinal(i_prev) <span class="symbol">|</span> <span class="type-name">Just</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lines(source<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">-&gt;</span> <span class="type-name">List</span> <span class="type-name">String</span> <span class="symbol">=</span>
  <span class="type-name">AsList</span>(_<span class="symbol">,</span> s) <span class="symbol">=</span> source
  <span class="type-name">AsList</span>(num_lines<span class="symbol">,</span> newline_ixs) <span class="symbol">=</span> cat_maybes <span class="keyword">for</span> i_char<span class="symbol">.</span>
    <span class="keyword">if</span> s[i_char] <span class="symbol">==</span> &#39;<span class="symbol">\</span>n&#39;
      <span class="keyword">then</span> <span class="type-name">Just</span>(i_char)
      <span class="keyword">else</span> <span class="type-name">Nothing</span>
  to_list <span class="keyword">for</span> i_line<span class="symbol">:</span>(<span class="type-name">Fin</span> num_lines)<span class="symbol">.</span>
    start <span class="symbol">=</span> <span class="keyword">case</span> prev_ix i_line <span class="keyword">of</span>
      <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> first_ix
      <span class="type-name">Just</span>(i) <span class="symbol">-&gt;</span> right_post newline_ixs[i]
    end <span class="symbol">=</span> left_post newline_ixs[i_line]
    post_slice(s<span class="symbol">,</span> start<span class="symbol">,</span> end)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Probability</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- cdf should include 0.0 but not 1.0
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical_from_cdf(cdf<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  r <span class="symbol">=</span> rand key
  <span class="keyword">case</span> search_sorted(cdf<span class="symbol">,</span> r) <span class="keyword">of</span>
    <span class="type-name">Just</span>(i) <span class="symbol">-&gt;</span> i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> normalize_pdf(xs<span class="symbol">:</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="keyword">given</span> (d<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> xs <span class="symbol">/</span> sum xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cdf_<span class="keyword">for</span>_categorical(logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  maxLogProb <span class="symbol">=</span> maximum logprobs
  cumsum_low <span class="symbol">$</span> normalize_pdf <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> exp(logprobs[i] <span class="symbol">-</span> maxLogProb)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical(logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">-&gt;</span> n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  categorical_from_cdf(cdf_<span class="keyword">for</span>_categorical logprobs<span class="symbol">,</span> key)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- batch variant to share the work of forming the cumsum
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- (alternatively we could rely on hoisting of loop constants)
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical_batch(logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">-&gt;</span> m<span class="symbol">=&gt;</span>n <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  cdf <span class="symbol">=</span> cdf_<span class="keyword">for</span>_categorical logprobs
  <span class="keyword">for</span> i<span class="symbol">.</span> categorical_from_cdf(cdf<span class="symbol">,</span> ixkey(key<span class="symbol">,</span> i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsumexp(x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  m <span class="symbol">+</span> (log <span class="symbol">$</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> exp (x[i] <span class="symbol">-</span> m))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsoftmax(x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  lse <span class="symbol">=</span> logsumexp x
  <span class="keyword">for</span> i<span class="symbol">.</span> x[i] <span class="symbol">-</span> lse
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> softmax(x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  e <span class="symbol">=</span>  <span class="keyword">for</span> i<span class="symbol">.</span> exp (x[i] <span class="symbol">-</span> m)
  s <span class="symbol">=</span> sum e
  <span class="keyword">for</span> i<span class="symbol">.</span> e[i] <span class="symbol">/</span> s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Polynomials</h2>
<p>TODO: Move this somewhere else</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> evalpoly(coefficients<span class="command">:n</span><span class="symbol">=&gt;</span>v<span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> v <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> v<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span>
  <span class="comment">-- Evaluate a polynomial at x.  Same as Numpy&#39;s polyval.
</span>  fold zero <span class="symbol">\</span>i c<span class="symbol">.</span> coefficients[i] <span class="symbol">+</span> x <span class="symbol">.*</span> c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>TestMode</h2>
<p>-- TODO: move this to be in Testing Helpers</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dex_test_mode() <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> unsafe_io <span class="symbol">\.</span> check_env &quot;<span class="type-name">DEX</span>_<span class="type-name">TEST</span>_<span class="type-name">MODE</span>&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Exception effect</h2>
<p>-- TODO: move <code>error</code> and <code>todo</code> to here.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> catch(f<span class="symbol">:</span>() <span class="symbol">-&gt;</span> {<span class="type-name">Except</span><span class="symbol">|</span>eff} a) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Maybe</span> a <span class="keyword">given</span> (a<span class="symbol">,</span> eff) <span class="symbol">=</span>
  f&#39; <span class="symbol">:</span> (() <span class="symbol">-&gt;</span> {<span class="type-name">Except</span><span class="symbol">|</span>eff} a) <span class="symbol">=</span> <span class="symbol">\.</span> f()
  %catchException(f&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> throw() <span class="symbol">-&gt;</span> {<span class="type-name">Except</span>} a <span class="keyword">given</span> (a) <span class="symbol">=</span>
  %throwException(a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> assert(b<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">-&gt;</span> {<span class="type-name">Except</span>} () <span class="symbol">=</span>
  <span class="keyword">if</span> not b <span class="keyword">then</span> throw()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Misc instances that require <code>error</code></h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(a<span class="symbol">,</span> <span class="type-name">Either</span>(a<span class="symbol">,</span>b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Data</span>)
  <span class="keyword">def</span> inject&#39;(x) <span class="symbol">=</span> <span class="type-name">Left</span> x
  <span class="keyword">def</span> project&#39;(x) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>( y) <span class="symbol">-&gt;</span> <span class="type-name">Just</span> y
    <span class="type-name">Right</span>(x) <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
  <span class="keyword">def</span> unsafe_project&#39;(x) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>( x) <span class="symbol">-&gt;</span> x
    <span class="type-name">Right</span>(x) <span class="symbol">-&gt;</span> error &quot;<span class="type-name">Can</span>&#39;t project <span class="type-name">Right</span> branch to <span class="type-name">Left</span> branch&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(b<span class="symbol">,</span> <span class="type-name">Either</span>(a<span class="symbol">,</span>b)) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Data</span>)
  <span class="keyword">def</span> inject&#39;(x) <span class="symbol">=</span>  <span class="type-name">Right</span> x
  <span class="keyword">def</span> project&#39;(x) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>( x) <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Right</span>(y) <span class="symbol">-&gt;</span> <span class="type-name">Just</span> y
  <span class="keyword">def</span> unsafe_project&#39;(x) <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span>( x) <span class="symbol">-&gt;</span> error &quot;<span class="type-name">Can</span>&#39;t project <span class="type-name">Left</span> branch to <span class="type-name">Right</span> branch&quot;
    <span class="type-name">Right</span>(x) <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Testing Helpers</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- -- Reliably causes a segfault if pointers aren&#39;t initialized to zero.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- -- TODO: add this test when we cache modules
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- justSomeDataToTestCaching = toList for i:(Fin 100).
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   if ordinal i == 0
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--     then Left (toList [1,2,3])
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--     else Right 1
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Index set for tables</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> int_to_reversed_digits(k<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> a<span class="symbol">=&gt;</span>b <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  base <span class="symbol">=</span> size b
  snd <span class="symbol">$</span> scan k <span class="symbol">\</span>_ cur_k<span class="symbol">.</span>
    next_k <span class="symbol">=</span> cur_k `idiv` base
    digit  <span class="symbol">=</span> cur_k `mod` base
    (next_k<span class="symbol">,</span> unsafe_from_ordinal(n<span class="symbol">=</span>b<span class="symbol">,</span> digit))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reversed_digits_to_int(digits<span class="symbol">:</span> a<span class="symbol">=&gt;</span>b) <span class="symbol">-&gt;</span> <span class="type-name">Nat</span> <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  base <span class="symbol">=</span> size b
  fst <span class="symbol">$</span> fold (0<span class="symbol">,</span> 1) <span class="symbol">\</span>j pair<span class="symbol">.</span>
    (cur_k<span class="symbol">,</span> cur_base) <span class="symbol">=</span> pair
    next_k <span class="symbol">=</span> cur_k <span class="symbol">+</span> ordinal digits[j] <span class="symbol">*</span> cur_base
    next_base <span class="symbol">=</span> cur_base <span class="symbol">*</span> base
    (next_k<span class="symbol">,</span> next_base)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(a<span class="symbol">=&gt;</span>b) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">Ix</span>)
  <span class="comment">-- 0@a is the least significant digit,
</span>  <span class="comment">-- while (size a - 1)@a is the most significant digit.
</span>  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> size b `intpow` size a
  <span class="keyword">def</span> ordinal(i) <span class="symbol">=</span> reversed_digits_to_int i
  <span class="keyword">def</span> unsafe_from_ordinal(i) <span class="symbol">=</span> int_to_reversed_digits i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">NonEmpty</span>(a<span class="symbol">=&gt;</span>b) <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> b<span class="symbol">|</span><span class="type-name">NonEmpty</span>)
  first_ix <span class="symbol">=</span> unsafe_from_ordinal 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>stack</h3>
<p>-- TODO: replace <code>DynBuffer</code> with this?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Stack</span>(h<span class="symbol">:</span><span class="type-name">Heap</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span> <span class="type-name">Ref</span>(h<span class="symbol">,</span> (<span class="type-name">Nat</span><span class="symbol">,</span> <span class="type-name">List</span> a))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> stack_size(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} <span class="type-name">Nat</span> <span class="keyword">given</span> (h<span class="symbol">,</span> a) <span class="symbol">=</span> get <span class="symbol">$</span> fst_ref stack
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafe_get_stack_buffer(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} (<span class="type-name">Ref</span>(h<span class="symbol">,</span> <span class="type-name">Fin</span> 0 <span class="symbol">=&gt;</span> a)) <span class="keyword">given</span> (h<span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  get <span class="symbol">$</span> snd_ref <span class="symbol">$</span> unsafe_coerce(to<span class="symbol">=</span><span class="type-name">Ref</span> h (<span class="type-name">Nat</span><span class="symbol">,</span> <span class="type-name">Ref</span> h (<span class="type-name">Fin</span> 0 <span class="symbol">=&gt;</span> a))<span class="symbol">,</span> snd_ref stack)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> stack_buf_size(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} <span class="type-name">Nat</span> <span class="keyword">given</span> (h<span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  get <span class="symbol">$</span> fst_ref <span class="symbol">$</span> unsafe_coerce(to<span class="symbol">=</span><span class="type-name">Ref</span> h (<span class="type-name">Nat</span><span class="symbol">,</span> <span class="type-name">Ref</span> h (<span class="type-name">Fin</span> 0 <span class="symbol">=&gt;</span> a))<span class="symbol">,</span> snd_ref stack)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ensure_size_at_least(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)<span class="symbol">,</span> req_size<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} () <span class="keyword">given</span> (h<span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  <span class="keyword">if</span> req_size <span class="symbol">&gt;</span> stack_buf_size stack <span class="keyword">then</span>
    <span class="comment">-- TODO: maybe this should use integer arithmetic?
</span>    new_buf_size <span class="symbol">=</span> f_to_n <span class="symbol">$</span> 2<span class="symbol">.</span>0 `pow` (ceil <span class="symbol">$</span> log2 <span class="symbol">$</span> n_to_f req_size)
    buf <span class="symbol">=</span> unsafe_get_stack_buffer stack
    logical_size <span class="symbol">=</span> stack_size stack
    cur_<span class="keyword">data</span> <span class="symbol">=</span> get <span class="symbol">$</span> unsafe_coerce(to<span class="symbol">=</span><span class="type-name">Ref</span>(h<span class="symbol">,</span> <span class="type-name">Fin</span> logical_size <span class="symbol">=&gt;</span> a)<span class="symbol">,</span> buf)
    snd_ref stack <span class="symbol">:=</span> to_list <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> new_buf_size)<span class="symbol">.</span>
      <span class="keyword">case</span> to_ix(n<span class="symbol">=</span><span class="type-name">Fin</span> logical_size<span class="symbol">,</span> ordinal i) <span class="keyword">of</span>
        <span class="type-name">Just</span>(i&#39;) <span class="symbol">-&gt;</span> cur_<span class="keyword">data</span>[i&#39;]
        <span class="type-name">Nothing</span>  <span class="symbol">-&gt;</span> uninitialized_value()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> read_stack(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} (<span class="type-name">List</span> a) <span class="keyword">given</span> (h<span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  n <span class="symbol">=</span> stack_size stack
  buf <span class="symbol">=</span> unsafe_coerce(to<span class="symbol">=</span><span class="type-name">Ref</span>(h<span class="symbol">,</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a)<span class="symbol">,</span> unsafe_get_stack_buffer stack)
  <span class="type-name">AsList</span>(n<span class="symbol">,</span> get buf)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> stack_push(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)<span class="symbol">,</span> x<span class="command">:a</span>) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} () <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> h) <span class="symbol">=</span>
  n_old <span class="symbol">=</span> stack_size stack
  n_new <span class="symbol">=</span> n_old <span class="symbol">+</span> 1
  ensure_size_at_least(stack<span class="symbol">,</span> n_new)
  buf <span class="symbol">=</span> unsafe_get_stack_buffer stack
  buf <span class="symbol">!</span> (unsafe_from_ordinal n_old) <span class="symbol">:=</span> x
  fst_ref stack <span class="symbol">:=</span> n_new
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>noinline
<span class="keyword">def</span> stack_extend(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)<span class="symbol">,</span> x<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} () <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> h) <span class="symbol">=</span>
  n_old <span class="symbol">=</span> stack_size stack
  n_new <span class="symbol">=</span> n_old <span class="symbol">+</span> size n
  ensure_size_at_least(stack<span class="symbol">,</span> n_new)
  buf <span class="symbol">=</span> unsafe_get_stack_buffer stack
  buf_slice <span class="symbol">=</span> unsafe_coerce(to<span class="symbol">=</span><span class="type-name">Ref</span>(h<span class="symbol">,</span>n<span class="symbol">=&gt;</span>a)<span class="symbol">,</span> buf <span class="symbol">!</span> (unsafe_from_ordinal n_old))
  buf_slice <span class="symbol">:=</span> x
  fst_ref stack <span class="symbol">:=</span> n_new
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> stack_pop(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> a)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} <span class="type-name">Maybe</span> a <span class="keyword">given</span> (a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span> h) <span class="symbol">=</span>
  n_old <span class="symbol">=</span> stack_size stack
  <span class="keyword">case</span> n_old <span class="symbol">==</span> 0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span>
      n_new <span class="symbol">=</span> unsafe_nat_diff(n_old<span class="symbol">,</span> 1)
      buf <span class="symbol">=</span> unsafe_get_stack_buffer stack
      fst_ref stack <span class="symbol">:=</span> n_new
      <span class="type-name">Just</span> <span class="symbol">$</span> get buf<span class="symbol">!</span>(unsafe_from_ordinal n_new)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">stack_init_size <span class="symbol">=</span> 16
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_stack(
    a<span class="symbol">|</span><span class="type-name">Data</span><span class="symbol">,</span>
    action<span class="symbol">:</span>(<span class="keyword">given</span> (h<span class="symbol">:</span><span class="type-name">Heap</span>)<span class="symbol">,</span> <span class="type-name">Stack</span>(h<span class="symbol">,</span> a)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h<span class="symbol">|</span>eff} r
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} r  <span class="keyword">given</span> (eff<span class="symbol">,</span> r) <span class="symbol">=</span>
  init_stack <span class="symbol">=</span> to_list <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> stack_init_size)<span class="symbol">.</span> uninitialized_value()
  with_state (0<span class="symbol">,</span> init_stack) <span class="symbol">\</span>ref <span class="symbol">.</span> action ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> stack_extend_internal(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> <span class="type-name">Char</span>)<span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Fin</span> n<span class="symbol">=&gt;</span><span class="type-name">Char</span>) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} () <span class="keyword">given</span> (n<span class="symbol">,</span> h) <span class="symbol">=</span>
  stack_extend(stack<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> stack_push_internal(stack<span class="symbol">:</span><span class="type-name">Stack</span>(h<span class="symbol">,</span> <span class="type-name">Char</span>)<span class="symbol">,</span> x<span class="symbol">:</span><span class="type-name">Char</span>) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} () <span class="keyword">given</span> (h) <span class="symbol">=</span>
  stack_push(stack<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> with_stack_internal(f<span class="symbol">:</span>(<span class="keyword">given</span> (h<span class="symbol">:</span><span class="type-name">Heap</span>)<span class="symbol">,</span> <span class="type-name">Stack</span>(h<span class="symbol">,</span> <span class="type-name">Char</span>)) <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h} ()) <span class="symbol">-&gt;</span> <span class="type-name">List</span> <span class="type-name">Char</span> <span class="symbol">=</span>
  with_stack <span class="type-name">Char</span> <span class="symbol">\</span>stack<span class="symbol">.</span>
    f stack
    read_stack stack
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> show_any(x<span class="command">:a</span>) <span class="symbol">-&gt;</span> <span class="type-name">String</span> <span class="keyword">given</span> (a) <span class="symbol">=</span> unsafe_coerce(to<span class="symbol">=</span><span class="type-name">String</span><span class="symbol">,</span> %showAny(x))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> coerce_table(m<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> x<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> m <span class="symbol">=&gt;</span> a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Data</span>) <span class="symbol">=</span>
  <span class="keyword">if</span> size m <span class="symbol">==</span> size n
    <span class="keyword">then</span> unsafe_coerce(to<span class="symbol">=</span>m<span class="symbol">=&gt;</span>a<span class="symbol">,</span> x)
    <span class="keyword">else</span> error &quot;mismatched sizes in table coercion&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Linear Algebra</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linspace(n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> low<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">,</span> high<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  dx <span class="symbol">=</span> (high <span class="symbol">-</span> low) <span class="symbol">/</span> n_to_f (size n)
  <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> low <span class="symbol">+</span> n_to_f (ordinal i) <span class="symbol">*</span> dx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose(x<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span>a) <span class="symbol">-&gt;</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a) <span class="symbol">=</span> <span class="keyword">for</span> i j<span class="symbol">.</span> x[j<span class="symbol">,</span>i]
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vdot(x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> y<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span> fsum <span class="keyword">for</span> i<span class="symbol">.</span> x[i] <span class="symbol">*</span> y[i]
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dot(s<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> vs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">-&gt;</span> v <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> v<span class="symbol">|</span><span class="type-name">VSpace</span>) <span class="symbol">=</span> sum <span class="keyword">for</span> j<span class="symbol">.</span> s[j] <span class="symbol">.*</span> vs[j]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> naive_matmul(x<span class="symbol">:</span> l<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> y<span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (l<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="keyword">given</span> (l<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">for</span> i k<span class="symbol">.</span> fsum <span class="keyword">for</span> j<span class="symbol">.</span> x[i<span class="symbol">,</span>j] <span class="symbol">*</span> y[j<span class="symbol">,</span>k]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- A `FullTileIx` type represents `tile_ix`th full tile (of size
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- `tile_size`) iterating over the index set `n`.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- This type is only well formed when tile_ix * tile_size &lt; size n.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">FullTileIx</span>(n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> tile_size<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> tile_ix<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">=</span>
  unwrap <span class="symbol">:</span> <span class="type-name">Fin</span> tile_size
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">FullTileIx</span>(n<span class="symbol">,</span> tile_size<span class="symbol">,</span> tile_ix)) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> tile_size<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> tile_ix<span class="symbol">:</span><span class="type-name">Nat</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> tile_size
  <span class="keyword">def</span> ordinal(i)  <span class="symbol">=</span> ordinal i<span class="symbol">.</span>unwrap
  <span class="keyword">def</span> unsafe_from_ordinal(i) <span class="symbol">=</span><span class="type-name">FullTileIx</span><span class="symbol">.</span>new <span class="symbol">$</span> unsafe_from_ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">FullTileIx</span>(n<span class="symbol">,</span> tile_size<span class="symbol">,</span> tile_ix)<span class="symbol">,</span> n) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> tile_size<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> tile_ix<span class="symbol">:</span><span class="type-name">Nat</span>)
  <span class="keyword">def</span> inject&#39;(i) <span class="symbol">=</span> unsafe_from_ordinal <span class="symbol">$</span> tile_size <span class="symbol">*</span> tile_ix <span class="symbol">+</span> ordinal i<span class="symbol">.</span>unwrap
  <span class="keyword">def</span> project&#39;(i) <span class="symbol">=</span> todo
  <span class="keyword">def</span> unsafe_project&#39;(i) <span class="symbol">=</span> todo
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- A `CodaIx` type represents the last few elements of the index set `n`,
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- as might be left over after iterating by tiles.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- This type is only well formed when size n == coda_offset + coda_size
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">struct</span> <span class="type-name">CodaIx</span>(n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> coda_offset<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> coda_size<span class="symbol">:</span><span class="type-name">Nat</span>) <span class="symbol">=</span>
  unwrap <span class="symbol">:</span> <span class="type-name">Fin</span> coda_size
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ix</span>(<span class="type-name">CodaIx</span>(n<span class="symbol">,</span> coda_offset<span class="symbol">,</span> coda_size)) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> coda_offset<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> coda_size<span class="symbol">:</span><span class="type-name">Nat</span>)
  <span class="keyword">def</span> size&#39;() <span class="symbol">=</span> coda_size
  <span class="keyword">def</span> ordinal(i) <span class="symbol">=</span> ordinal i<span class="symbol">.</span>unwrap
  <span class="keyword">def</span> unsafe_from_ordinal(i) <span class="symbol">=</span> <span class="type-name">CodaIx</span><span class="symbol">.</span>new <span class="symbol">$</span> unsafe_from_ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Subset</span>(<span class="type-name">CodaIx</span>(n<span class="symbol">,</span> coda_offset<span class="symbol">,</span> coda_size)<span class="symbol">,</span> n) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> coda_offset<span class="symbol">:</span><span class="type-name">Nat</span><span class="symbol">,</span> coda_size<span class="symbol">:</span><span class="type-name">Nat</span>)
  <span class="keyword">def</span> inject&#39;(i) <span class="symbol">=</span> unsafe_from_ordinal <span class="symbol">$</span> coda_offset <span class="symbol">+</span> ordinal i<span class="symbol">.</span>unwrap
  <span class="keyword">def</span> project&#39;(i) <span class="symbol">=</span> todo
  <span class="keyword">def</span> unsafe_project&#39;(i) <span class="symbol">=</span> todo
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile(
    n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span>
    tile_size<span class="symbol">:</span> <span class="type-name">Nat</span><span class="symbol">,</span>
    body<span class="symbol">:</span>(m<span class="symbol">:</span><span class="type-name">Type</span><span class="symbol">,</span> <span class="keyword">given</span> () (<span class="type-name">Ix</span> m<span class="symbol">,</span> <span class="type-name">Subset</span>(m<span class="symbol">,</span> n))) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} ()
    ) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} ()  <span class="keyword">given</span> (eff) <span class="symbol">=</span>
  num_tiles <span class="symbol">=</span> size n `idiv` tile_size
  coda_size <span class="symbol">=</span> size n `rem` tile_size
  coda_offset <span class="symbol">=</span> num_tiles <span class="symbol">*</span> tile_size
  <span class="keyword">for</span>_ tile_ix<span class="symbol">:</span>(<span class="type-name">Fin</span> num_tiles)<span class="symbol">.</span>
    tile_ix&#39; <span class="symbol">=</span> ordinal tile_ix
    body (<span class="type-name">FullTileIx</span>(n<span class="symbol">,</span> tile_size<span class="symbol">,</span> tile_ix&#39;))
  body (<span class="type-name">CodaIx</span>(n<span class="symbol">,</span> coda_offset<span class="symbol">,</span> coda_size))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- matmul. Better symbol to use? `@`?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">**</span>)(
    x<span class="symbol">:</span> l<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span>
    y<span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>
    ) <span class="symbol">-&gt;</span> l<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>  <span class="keyword">given</span> (l<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> n<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="comment">-- Tile sizes picked for axch&#39;s laptop
</span>  l_tile_size <span class="symbol">=</span> 32
  n_tile_size <span class="symbol">=</span> 128
  m_tile_size <span class="symbol">=</span> 8
  yield_accum (<span class="type-name">AddMonoid</span> <span class="type-name">Float</span>) <span class="symbol">\</span>result<span class="symbol">.</span>
    tile(l<span class="symbol">,</span> l_tile_size) <span class="symbol">\</span>l_set<span class="symbol">.</span>
      tile(n<span class="symbol">,</span> n_tile_size) <span class="symbol">\</span>n_set<span class="symbol">.</span>
        tile(m<span class="symbol">,</span> m_tile_size) <span class="symbol">\</span>m_set<span class="symbol">.</span>
          <span class="keyword">for</span>_ l_offset<span class="command">:l</span>_set<span class="symbol">.</span>
            l_ix <span class="symbol">=</span> inject(to<span class="symbol">=</span>l<span class="symbol">,</span> l_offset)
            <span class="keyword">for</span>_ n_offset<span class="command">:n</span>_set<span class="symbol">.</span>
              n_ix <span class="symbol">=</span> inject n_offset
              <span class="keyword">for</span>_ m_offset<span class="command">:m</span>_set<span class="symbol">.</span>
                m_ix <span class="symbol">=</span> inject m_offset
                result<span class="symbol">!</span>l_ix<span class="symbol">!</span>n_ix <span class="symbol">+=</span> x[l_ix<span class="symbol">,</span>m_ix] <span class="symbol">*</span> y[m_ix<span class="symbol">,</span>n_ix]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">**.</span>)(mat<span class="symbol">:</span> n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> v<span class="symbol">:</span> m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> vdot(mat[i]<span class="symbol">,</span> v)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span>(<span class="symbol">.**</span>)(v<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> mat<span class="symbol">:</span> n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  transpose mat <span class="symbol">**.</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inner(x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> mat<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span><span class="symbol">,</span> y<span class="command">:m</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> m<span class="symbol">|</span><span class="type-name">Ix</span>) <span class="symbol">=</span>
  fsum <span class="keyword">for</span> p<span class="symbol">.</span>
    (i<span class="symbol">,</span>j) <span class="symbol">=</span> p
    x[i] <span class="symbol">*</span> mat[i<span class="symbol">,</span>j] <span class="symbol">*</span> y[j]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> eye() <span class="symbol">-&gt;&gt;</span> n<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="keyword">given</span> (n<span class="symbol">|</span><span class="type-name">Ix</span><span class="symbol">,</span> a<span class="symbol">|</span><span class="type-name">Add</span><span class="symbol">|</span><span class="type-name">Mul</span>) <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> select(ordinal i <span class="symbol">==</span> ordinal j<span class="symbol">,</span> one<span class="symbol">,</span> zero)
</div></div></div></body></html>